<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Pixy インサイト</title>
  <style>
    :root{
      --bg:#f7f7fb;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;

      --pink:#fde2ea;
      --pinkBorder: rgba(240, 182, 199, .38);

      --blue:#2563eb;
      --blueSoft: rgba(37,99,235,.18);

      --shadow: 0 10px 26px rgba(0,0,0,.08);
      --radius: 18px;

      --chip:#e9eaef;
      --chipOn:#4b5563;

      --grid:#e5e7eb;
    }

    html{
      -webkit-text-size-adjust: 100%;
      text-size-adjust: 100%;
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", "Hiragino Sans", "Noto Sans JP", Arial, sans-serif;
    }

    .app{
      max-width: 420px;
      margin: 0 auto;
      padding: 16px 14px 26px;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-top: 8px;
      margin-bottom: 4px;
    }

    .brand{
      font-weight: 900;
      font-size: 22px;
      letter-spacing:.2px;
    }

    .title{
      font-weight: 900;
      font-size: 20px;
      letter-spacing:.1px;
    }

    .sectionTitle{
      margin-top: 18px;
      font-weight: 900;
      font-size: 22px;
      letter-spacing:.2px;
    }

    .divider{
      height:3px;
      background: #f0b6c7;
      border-radius: 999px;
      margin: 10px 0 14px;
      opacity:.6;
    }

    .cardRow{
      display:flex;
      gap: 12px;
      align-items:stretch;
    }

    .card{
      background: var(--card);
      border: 1px solid rgba(0,0,0,.05);
      border-radius: var(--radius);
      box-shadow: 0 8px 18px rgba(0,0,0,.04);
      padding: 14px;
      flex: 1;
      min-width: 0;
    }

    .card.pink{
      background: var(--pink);
      border-color: var(--pinkBorder);
    }

    .card h3{
      margin:0 0 8px;
      font-size: 13px;
      color: var(--muted);
      font-weight: 900;
      letter-spacing:.1px;
    }

    .bigMoney{
      font-weight: 1000;
      letter-spacing: .4px;
      color: var(--blue);
      margin: 2px 0 6px;
      font-size: clamp(30px, 8.6vw, 38px);
      line-height: 1.05;
    }

    .subLine{
      display:flex;
      align-items:baseline;
      gap: 8px;
      color: var(--muted);
      font-weight: 900;
      font-size: 12px;
    }
    .subLine b{
      color: var(--text);
      font-size: 13px;
      font-weight: 1000;
    }

    .detailBtn{
      appearance:none;
      border:none;
      text-align:left;
      cursor:pointer;
      width:100%;
      background: var(--card);
    }
    .detailBtn:active{
      transform: translateY(1px);
    }

    .kpiGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px 12px;
      margin-top: 6px;
    }

    .miniLabel{
      font-size: 11px;
      color: var(--muted);
      font-weight: 900;
      margin-bottom: 2px;
    }

    .miniVal{
      font-size: 22px;
      color: var(--blue);
      font-weight: 1000;
      letter-spacing:.2px;
      line-height: 1.05;
    }

    .toggleRow{
      display:flex;
      gap: 10px;
      margin: 12px 0 10px;
    }

    .toggle{
      border: none;
      border-radius: 999px;
      padding: 10px 16px;
      font-weight: 1000;
      font-size: 14px;
      background: var(--chip);
      color: #374151;
      cursor: pointer;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.03);
    }
    .toggle.active{
      background: var(--chipOn);
      color: #fff;
    }

    .chartCard{
      background: var(--card);
      border: 1px solid rgba(0,0,0,.05);
      border-radius: var(--radius);
      box-shadow: 0 8px 18px rgba(0,0,0,.04);
      padding: 10px 10px 12px;
      overflow: hidden;
    }

    .chartWrap{
      position:relative;
      height: 180px;
      margin-top: 4px;
      border-radius: 12px;
      background:#fff;
      overflow:hidden;
    }

    .chartViewport{
      position:absolute;
      left:0; right:0; top:0; bottom:28px;
      overflow-x:auto;
      overflow-y:hidden;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      touch-action: pan-y;
    }
    .chartViewport::-webkit-scrollbar{ display:none; }

    .chartInner{
      position:relative;
      height:100%;
      width:100%;
    }

    canvas{
      display:block;
      width:100%;
      height:100%;
    }

    .yLabels{
      position:absolute;
      right: 8px;
      top: 10px;
      bottom: 34px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      font-size: 12px;
      color: #9ca3af;
      font-weight: 900;
      pointer-events:none;
      letter-spacing:.1px;
    }

    .xLabelsViewport{
      height: 28px;
      overflow-x:auto;
      overflow-y:hidden;
      -webkit-overflow-scrolling: touch;
      scrollbar-width:none;
      user-select:none;
    }
    .xLabelsViewport::-webkit-scrollbar{ display:none; }

    .xLabels{
      display:flex;
      padding: 0 8px;
      height: 28px;
      align-items:flex-end;
      color: #9ca3af;
      font-weight: 900;
      font-size: 12px;
      white-space:nowrap;
      width:max-content;
    }
    .xLabels span{
      width: var(--slot, 50px);
      text-align:center;
      flex: 0 0 auto;
    }

    .cursorLine{
      position:absolute;
      top: 10px;
      bottom: 10px;
      width:2px;
      background: rgba(37,99,235,.55);
      border-radius:999px;
      pointer-events:none;
      display:none;
      z-index: 3;
    }

    .tooltip{
      position:absolute;
      min-width: 88px;
      padding: 8px 10px;
      background:#fff;
      border:1px solid rgba(0,0,0,.08);
      box-shadow: 0 10px 26px rgba(0,0,0,.14);
      border-radius: 10px;
      transform: translate(-50%, -112%);
      pointer-events:none;
      display:none;
      white-space:nowrap;
      z-index: 4;
    }
    .tooltip .tLabel{
      color: var(--text);
      font-weight: 1000;
      font-size: 16px;
      margin-bottom: 2px;
      letter-spacing:.1px;
    }
    .tooltip .tVal{
      color: var(--muted);
      font-weight: 1000;
      font-size: 14px;
      letter-spacing:.1px;
    }

    .tabsRow{
      display:flex;
      gap: 10px;
      margin-top: 10px;
    }
    .tab{
      border:none;
      border-radius:999px;
      padding: 10px 16px;
      font-weight: 1000;
      font-size: 14px;
      background: var(--chip);
      color: #374151;
      cursor:pointer;
    }
    .tab.active{
      background: var(--chipOn);
      color:#fff;
    }

    .panelCard{
      background: var(--card);
      border: 1px solid rgba(0,0,0,.05);
      border-radius: var(--radius);
      box-shadow: 0 8px 18px rgba(0,0,0,.04);
      padding: 14px 14px 12px;
      margin-top: 10px;
    }

    .panelTitle{
      font-weight: 1000;
      color:#374151;
      margin-bottom: 10px;
      letter-spacing:.1px;
    }

    .ratioRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin: 10px 0 8px;
      font-weight: 1000;
    }
    .ratioRow .lab{
      font-size: 15px;
      color: var(--text);
      min-width: 86px;
    }
    .ratioRow .pct{
      font-size: 18px;
      color: var(--text);
    }

    .bar{
      height: 10px;
      background: #e5e7eb;
      border-radius: 999px;
      overflow:hidden;
    }
    .bar > i{
      display:block;
      height:100%;
      width: 50%;
      background: var(--blue);
      border-radius: 999px;
    }

    .ageRow{
      margin: 14px 0 10px;
    }
    .ageHead{
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-weight: 1000;
      margin-bottom: 8px;
    }
    .ageHead .lab{ font-size: 15px; }
    .ageHead .pct{ font-size: 18px; }

    @media (max-width: 360px){
      .cardRow{ gap:10px; }
      .miniVal{ font-size: 20px; }
      .toggle, .tab{ padding: 10px 14px; }
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="topbar">
      <div class="brand">Pixy</div>
      <div class="title">インサイト</div>
      <div style="width:54px"></div>
    </div>

    <div class="sectionTitle">メインデータ</div>
    <div class="divider"></div>

    <div class="cardRow">
      <div class="card pink">
        <h3>今月の報酬金</h3>
        <div class="bigMoney" id="kpiMoney">¥ 100,000</div>
        <div class="subLine">前月比 <b id="kpiMoM">101%</b></div>
      </div>

      <div class="card" style="padding:0">
        <button class="detailBtn" id="detailCardBtn" style="padding:14px;border-radius:18px;">
          <h3>鑑定データ詳細</h3>
          <div class="kpiGrid">
            <div>
              <div class="miniLabel">リピート件数</div>
              <div class="miniVal" id="kpiRepeatCnt">13</div>
            </div>
            <div>
              <div class="miniLabel">リピート人数</div>
              <div class="miniVal" id="kpiRepeatUsers">9</div>
            </div>
            <div>
              <div class="miniLabel">鑑定件数</div>
              <div class="miniVal" id="kpiKanteiCnt">76</div>
            </div>
            <div>
              <div class="miniLabel">鑑定人数</div>
              <div class="miniVal" id="kpiKanteiUsers">63</div>
            </div>
          </div>
        </button>
      </div>
    </div>

    <div class="toggleRow" aria-label="グラフ切替">
      <button class="toggle active" data-mode="hour">時間別</button>
      <button class="toggle" data-mode="weekday">曜日別</button>
      <button class="toggle" data-mode="day">日別</button>
    </div>

    <div class="chartCard">
      <div class="chartWrap">
        <div class="chartViewport" id="chartViewport">
          <div class="chartInner" id="chartInner">
            <canvas id="chart"></canvas>
            <div class="cursorLine" id="cursorLine"></div>
            <div class="tooltip" id="tooltip">
              <div class="tLabel" id="tipLabel">02時</div>
              <div class="tVal" id="tipValue">¥ 800</div>
            </div>
          </div>
        </div>

        <div class="yLabels">
          <div id="yTop">1,155</div>
          <div id="yMid">770</div>
          <div id="yBot">385</div>
        </div>
      </div>

      <div class="xLabelsViewport" id="xLabelsViewport">
        <div class="xLabels" id="xLabels"></div>
      </div>
    </div>

    <div class="sectionTitle" id="detailSection">詳細データ</div>
    <div class="divider"></div>

    <div class="tabsRow">
      <button class="tab active" data-tab="user">ユーザー分析</button>
      <button class="tab" data-tab="kanteishi">鑑定師分析</button>
    </div>

    <div id="tabUser">
      <div class="panelCard">
        <div class="panelTitle">男女比率</div>

        <div class="ratioRow">
          <div class="lab">女性</div>
          <div class="pct" id="gFemale">0%</div>
        </div>
        <div class="bar"><i id="bFemale" style="width:0%"></i></div>

        <div class="ratioRow" style="margin-top:14px;">
          <div class="lab">男性</div>
          <div class="pct" id="gMale">0%</div>
        </div>
        <div class="bar"><i id="bMale" style="width:0%"></i></div>

        <div style="margin-top:10px;color:#6b7280;font-weight:900;font-size:12px;letter-spacing:.1px;">
          ※ここは「ユーザーマスタ×鑑定ログ」から計算した値を入れる想定
        </div>
      </div>

      <div class="panelCard">
        <div class="panelTitle">年齢構成比</div>

        <div class="ageRow">
          <div class="ageHead"><div class="lab">-29</div><div class="pct" id="a1">0%</div></div>
          <div class="bar"><i id="ab1" style="width:0%"></i></div>
        </div>

        <div class="ageRow">
          <div class="ageHead"><div class="lab">30-39</div><div class="pct" id="a2">0%</div></div>
          <div class="bar"><i id="ab2" style="width:0%"></i></div>
        </div>

        <div class="ageRow">
          <div class="ageHead"><div class="lab">40-49</div><div class="pct" id="a3">0%</div></div>
          <div class="bar"><i id="ab3" style="width:0%"></i></div>
        </div>

        <div class="ageRow">
          <div class="ageHead"><div class="lab">50-59</div><div class="pct" id="a4">0%</div></div>
          <div class="bar"><i id="ab4" style="width:0%"></i></div>
        </div>

        <div class="ageRow">
          <div class="ageHead"><div class="lab">60-69</div><div class="pct" id="a5">0%</div></div>
          <div class="bar"><i id="ab5" style="width:0%"></i></div>
        </div>

        <div class="ageRow" style="margin-bottom:0;">
          <div class="ageHead"><div class="lab">70-</div><div class="pct" id="a6">0%</div></div>
          <div class="bar"><i id="ab6" style="width:0%"></i></div>
        </div>
      </div>
    </div>

    <div id="tabKanteishi" style="display:none">
      <div class="panelCard">
        <div class="panelTitle">鑑定師分析</div>
        <div style="color:#6b7280;font-weight:900;font-size:13px;letter-spacing:.1px;">
          ここは次段階で「鑑定師ごとの差分」が出るように拡張できます。
        </div>
      </div>
    </div>

  </div>

<script>
  const APP = {
    state: { month: "12月", chartMode: "hour", cursorIndex: null },
    dataByMonth: {
      "12月": {
        money: 100000, mom: 101,
        repeatCnt: 13, repeatUsers: 9,
        kanteiCnt: 76, kanteiUsers: 63,
        gender: { female: 62.0, male: 38.0 },
        ageBuckets: { a1: 18.0, a2: 31.0, a3: 21.0, a4: 14.0, a5: 10.0, a6: 6.0 },
        chart: {
          hour:    { labels: ["02時","03時","04時","05時","06時"], values: [820,860,780,815,790] },
          weekday: { labels: ["月","火","水","木","金","土","日"], values: [700,820,760,810,900,740,680] },
          day:     { labels: ["4日","5日","6日","7日","8日","9日","14日","15日","16日","17日","18日","19日"], values: [900,820,830,810,890,850,1100,980,918,900,780,650] }
        }
      }
    }
  };

  const $ = (q)=>document.querySelector(q);

  function fmtYen(n){
    return "¥ " + Math.round(n).toLocaleString("ja-JP");
  }

  function setPct(el, barEl, v){
    const vv = Math.max(0, Math.min(100, Number(v)||0));
    el.textContent = vv.toFixed(1).replace(/\.0$/, "") + "%";
    barEl.style.width = vv + "%";
  }

  function syncKpiAndUser(){
    const d = APP.dataByMonth[APP.state.month];

    $("#kpiMoney").textContent = fmtYen(d.money);
    $("#kpiMoM").textContent = d.mom + "%";
    $("#kpiRepeatCnt").textContent = d.repeatCnt.toLocaleString("ja-JP");
    $("#kpiRepeatUsers").textContent = d.repeatUsers.toLocaleString("ja-JP");
    $("#kpiKanteiCnt").textContent = d.kanteiCnt.toLocaleString("ja-JP");
    $("#kpiKanteiUsers").textContent = d.kanteiUsers.toLocaleString("ja-JP");

    setPct($("#gFemale"), $("#bFemale"), d.gender.female);
    setPct($("#gMale"), $("#bMale"), d.gender.male);

    const a = d.ageBuckets;
    setPct($("#a1"), $("#ab1"), a.a1);
    setPct($("#a2"), $("#ab2"), a.a2);
    setPct($("#a3"), $("#ab3"), a.a3);
    setPct($("#a4"), $("#ab4"), a.a4);
    setPct($("#a5"), $("#ab5"), a.a5);
    setPct($("#a6"), $("#ab6"), a.a6);
  }

  const chart = {
    canvas: $("#chart"),
    viewport: $("#chartViewport"),
    inner: $("#chartInner"),
    ctx: null,
    w: 0, h: 0,
    slot: 50,
    padding: { top: 16, right: 14, bottom: 16, left: 14 },
    points: [],
    init(){
      this.ctx = this.canvas.getContext("2d");
      this.resize();
    },
    resize(){
      const rect = this.inner.getBoundingClientRect();
      const w = Math.max(10, rect.width);
      const h = Math.max(10, rect.height);
      this.w = w; this.h = h;

      const dpr = window.devicePixelRatio || 1;
      this.canvas.width = Math.floor(w * dpr);
      this.canvas.height = Math.floor(h * dpr);
      this.canvas.style.width = w + "px";
      this.canvas.style.height = h + "px";
      this.ctx.setTransform(dpr,0,0,dpr,0,0);
    },
    setInnerWidth(n){
      const innerW = (n-1)*this.slot + this.padding.left + this.padding.right;
      this.inner.style.width = Math.max(innerW, this.viewport.clientWidth) + "px";
      $("#xLabels").style.setProperty("--slot", this.slot + "px");
    },
    draw(){
      const ctx = this.ctx;
      const w = this.w, h = this.h;
      const p = this.padding;

      const d = APP.dataByMonth[APP.state.month].chart[APP.state.chartMode];
      const labels = d.labels;
      const values = d.values;
      const n = values.length;

      this.setInnerWidth(n);
      this.resize();

      ctx.clearRect(0,0,w,h);
      ctx.fillStyle = "#ffffff";
      ctx.fillRect(0,0,w,h);

      const maxV = Math.max(...values);
      const minV = Math.min(...values);
      const padV = Math.max(1, (maxV - minV) * 0.18);

      const topV = Math.ceil((maxV + padV)/5)*5;
      const botV = Math.floor((minV - padV)/5)*5;

      $("#yTop").textContent = topV.toLocaleString("ja-JP");
      $("#yMid").textContent = Math.round((topV+botV)/2).toLocaleString("ja-JP");
      $("#yBot").textContent = botV.toLocaleString("ja-JP");

      const mapY = (v)=>{
        const t = (v - botV) / (topV - botV);
        return (h - p.bottom - 8) - t * (h - p.top - p.bottom - 16);
      };
      const mapX = (i)=> p.left + i * this.slot;

      const gridYs = [ p.top + 8, (h + p.top - p.bottom)/2, h - p.bottom - 8 ];
      ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue("--grid").trim() || "#e5e7eb";
      ctx.lineWidth = 1;
      ctx.setLineDash([3,4]);
      gridYs.forEach(y=>{
        ctx.beginPath();
        ctx.moveTo(p.left, y);
        ctx.lineTo(w - p.right, y);
        ctx.stroke();
      });
      ctx.setLineDash([]);

      const pts = [];
      for(let i=0;i<n;i++){
        pts.push({ i, x: mapX(i), y: mapY(values[i]), v: values[i] });
      }
      this.points = pts;

      const grad = ctx.createLinearGradient(0, p.top, 0, h);
      grad.addColorStop(0, "rgba(37,99,235,.20)");
      grad.addColorStop(1, "rgba(37,99,235,0)");
      ctx.fillStyle = grad;

      ctx.beginPath();
      pts.forEach((pt, idx)=>{
        if(idx===0) ctx.moveTo(pt.x, pt.y);
        else ctx.lineTo(pt.x, pt.y);
      });
      ctx.lineTo(pts[pts.length-1].x, h - p.bottom);
      ctx.lineTo(pts[0].x, h - p.bottom);
      ctx.closePath();
      ctx.fill();

      ctx.beginPath();
      pts.forEach((pt, idx)=>{
        if(idx===0) ctx.moveTo(pt.x, pt.y);
        else ctx.lineTo(pt.x, pt.y);
      });
      ctx.lineWidth = 2;
      ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue("--blue").trim() || "#2563eb";
      ctx.stroke();

      const idx = (APP.state.cursorIndex==null ? Math.floor(n/2) : APP.state.cursorIndex);
      const sel = pts[Math.max(0,Math.min(n-1,idx))];

      ctx.beginPath();
      ctx.arc(sel.x, sel.y, 4, 0, Math.PI*2);
      ctx.fillStyle = "#2563eb";
      ctx.fill();
      ctx.lineWidth = 2;
      ctx.strokeStyle = "#ffffff";
      ctx.stroke();

      renderXLabels(labels);
      renderTooltip(sel.x, sel.y, labels[sel.i], sel.v);
      syncScrollbars();
    }
  };

  function renderXLabels(labels){
    const row = $("#xLabels");
    row.innerHTML = "";
    labels.forEach(lab=>{
      const sp = document.createElement("span");
      sp.textContent = lab;
      row.appendChild(sp);
    });
  }

  function renderTooltip(x, y, label, value){
    const cursorLine = $("#cursorLine");
    const tooltip = $("#tooltip");
    cursorLine.style.display = "block";
    tooltip.style.display = "block";

    cursorLine.style.left = x + "px";

    $("#tipLabel").textContent = label;
    $("#tipValue").textContent = fmtYen(value);

    const minX = 54;
    const maxX = chart.inner.clientWidth - 54;
    const clampedX = Math.max(minX, Math.min(maxX, x));
    tooltip.style.left = clampedX + "px";
    tooltip.style.top = y + "px";
  }

  function pickIndexFromClientX(clientX){
    const d = APP.dataByMonth[APP.state.month].chart[APP.state.chartMode];
    const n = d.values.length;

    const rect = chart.viewport.getBoundingClientRect();
    const xInViewport = clientX - rect.left;
    const xInInner = xInViewport + chart.viewport.scrollLeft;

    const x0 = chart.padding.left;
    const i = Math.round((xInInner - x0) / chart.slot);
    return Math.max(0, Math.min(n-1, i));
  }

  function syncScrollbars(){
    const vp = $("#chartViewport");
    const xvp = $("#xLabelsViewport");
    xvp.scrollLeft = vp.scrollLeft;
  }

  function attachInteractions(){
    const vp = $("#chartViewport");
    const xvp = $("#xLabelsViewport");

    vp.addEventListener("scroll", ()=>{ xvp.scrollLeft = vp.scrollLeft; }, {passive:true});
    xvp.addEventListener("scroll", ()=>{ vp.scrollLeft = xvp.scrollLeft; }, {passive:true});

    vp.addEventListener("touchstart", (e)=>{
      const t = e.touches && e.touches[0];
      if(!t) return;
      APP.state.cursorIndex = pickIndexFromClientX(t.clientX);
      chart.draw();
    }, {passive:true});

    vp.addEventListener("touchmove", (e)=>{
      const t = e.touches && e.touches[0];
      if(!t) return;
      APP.state.cursorIndex = pickIndexFromClientX(t.clientX);
      chart.draw();
    }, {passive:true});

    vp.addEventListener("pointerdown", (e)=>{
      if(e.pointerType !== "mouse") return;
      if(e.button !== 0) return;
      APP.state.cursorIndex = pickIndexFromClientX(e.clientX);
      chart.draw();
    });

    const detailBtn = $("#detailCardBtn");
    const detailSec = $("#detailSection");
    if(detailBtn && detailSec){
      detailBtn.addEventListener("click", ()=>{
        detailSec.scrollIntoView({behavior:"smooth", block:"start"});
      });
    }

    document.querySelectorAll(".toggle").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        document.querySelectorAll(".toggle").forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        APP.state.chartMode = btn.dataset.mode;
        APP.state.cursorIndex = null;
        chart.draw();
      });
    });

    document.querySelectorAll(".tab").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        document.querySelectorAll(".tab").forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        const tab = btn.dataset.tab;
        $("#tabUser").style.display = (tab==="user") ? "" : "none";
        $("#tabKanteishi").style.display = (tab==="kanteishi") ? "" : "none";
      });
    });
  }

  function init(){
    syncKpiAndUser();
    chart.init();
    attachInteractions();

    const ro = new ResizeObserver(()=>{
      chart.resize();
      chart.draw();
    });
    ro.observe($("#chartInner"));

    chart.draw();
  }

  init();
</script>
</body>
</html>
