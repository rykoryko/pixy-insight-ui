<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ピクシーインサイト</title>
  <style>
    :root{
      --bg:#f3f4f8;
      --card:#ffffff;
      --ink:#111827;
      --muted:#6b7280;
      --line:#2f6df6;
      --pill:#e9ecf5;
      --pillActive:#111827;
      --pillActiveText:#ffffff;
      --shadow: 0 10px 24px rgba(17,24,39,.08);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans JP", "Hiragino Kaku Gothic ProN", "Yu Gothic", sans-serif;
      background:var(--bg);
      color:var(--ink);
    }
    .wrap{padding:18px 16px calc(28px + env(safe-area-inset-bottom)); max-width:520px; margin:0 auto;}
    .topRow{display:flex; align-items:flex-start; justify-content:space-between; gap:10px;}
    .pageTitle{font-size:26px;font-weight:800;letter-spacing:0.2px;line-height:1.15;word-break:keep-all;white-space:nowrap;}
    .subtitle{margin-top:6px; color:var(--muted); font-weight:700}
    .monthTabs{display:flex;gap:10px;align-items:center;overflow-x:auto;flex-wrap:nowrap;padding-bottom:6px;-webkit-overflow-scrolling:touch;}
.monthTabs::-webkit-scrollbar{display:none;}

    .pill{
      border:0;
      background:var(--pill);
      color:var(--ink);
      border-radius:999px;
      padding:10px 16px;
      font-weight:800;
      min-width:64px;
      cursor:pointer;
      white-space:nowrap;
    }
    .pill.active{
      background:var(--pillActive);
      color:var(--pillActiveText);
    }

    .section{margin-top:16px;}
    .card{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;
    }

    .kpiGrid{display:grid; grid-template-columns: 1.1fr .9fr; gap:12px;}
    .kpiLeft{
      background:linear-gradient(180deg,#ffd6e6 0%, #ffe9f1 60%, #ffffff 100%);
      border-radius:var(--radius);
      padding:16px;
      min-height:120px;
    }
    .kpiLeft .label{font-weight:900; color:#6b7280;}
    .kpiLeft .big{font-size:44px; font-weight:1000; margin-top:6px; color:#2f6df6;}
    .kpiLeft .small{margin-top:10px; font-weight:900; color:#6b7280}
    .kpiRight{
      border-radius:var(--radius);
      border:2px solid #111827;
      padding:14px 14px 10px;
      background:#fff;
      min-height:120px;
      cursor:pointer;
    }
    .kpiRight .title{font-weight:1000; color:#6b7280;}
    .kpiRight .miniGrid{display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;}
    .mini .t{font-size:12px; color:#6b7280; font-weight:900;}
    .mini .v{font-size:28px; font-weight:1000; color:#2f6df6; margin-top:2px;}

    .chartTabs{display:flex; gap:12px; justify-content:center; margin-top:14px;}
    .chartTabs .pill{min-width:90px}

    .chartWrap{margin-top:12px;}
    .chartViewport{
      position:relative;
      border-radius:18px;
      background:linear-gradient(180deg,#f1f5ff 0%, #ffffff 70%);
      overflow:hidden;
      height:220px;
      touch-action:none;
    }
    canvas{display:block; width:100%; height:100%;}
    .yAxisLabels{
      position:absolute;
      right:8px;
      top:12px;
      bottom:34px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      pointer-events:none;
      color:#8a93a6;
      font-weight:900;
      font-size:12px;
      text-align:right;
    }
    .xAxisLabels{position:relative;height:18px;margin:8px 0 0;user-select:none;}
.xAxisLabels span{position:absolute;top:0;transform:translateX(-50%);white-space:nowrap;}
.xAxisLabels span.first{transform:translateX(0%);}
.xAxisLabels span.last{transform:translateX(-100%);}

    .tooltip{
      position:absolute;
      left:14px;
      top:24px;
      background:#fff;
      border-radius:14px;
      box-shadow:var(--shadow);
      padding:10px 12px;
      font-weight:1000;
      pointer-events:none;
      min-width:92px;
    }
    .tooltip .d{font-size:18px}
    .tooltip .m{font-size:34px; color:#6b7280; margin-top:2px}
    .cursorLine{
      position:absolute;
      top:12px;
      bottom:36px;
      width:2px;
      background:rgba(47,109,246,.35);
      pointer-events:none;
    }
    .dot{
      position:absolute;
      width:10px;
      height:10px;
      border-radius:50%;
      background:#fff;
      border:3px solid #2f6df6;
      pointer-events:none;
      transform:translate(-50%,-50%);
    }

    .detailHeader{margin-top:18px; font-size:22px; font-weight:1000;}
    .detailTabs{display:flex; gap:12px; margin-top:12px;}
    .detailTabs .pill{min-width:120px}

    .panel{margin-top:12px;}
    .panelTitle{font-size:18px; font-weight:1000;}
    .muted{color:var(--muted); font-weight:800;}
    .ageRow{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-top:12px;}
    .ageRow .barWrap{flex:1; height:12px; background:#edf0f7; border-radius:999px; overflow:hidden;}
    .ageRow .bar{height:100%; background:#2f6df6;}
    .ageRow .label{min-width:70px; font-weight:1000;}
    .ageRow .pct{min-width:64px; text-align:right; font-weight:1000;}

    .hidden{display:none !important;}

    .subKpiGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px;}
    .subKpi{background:#f5f6fb;border:1px solid #e6e8f2;border-radius:14px;padding:12px 12px;}
    .subKpi .label{font-size:12px;color:#6b7280;font-weight:700;}
    .subKpi .value{margin-top:6px;font-size:20px;font-weight:900;letter-spacing:0.2px;}
    .subNote{margin-top:10px;font-size:12px;color:#6b7280;}
    @media (max-width: 360px){.pageTitle{font-size:22px;} .kpiLeft .big{font-size:38px;} .subKpi .value{font-size:18px;}}

    table{width:100%; border-collapse:collapse; margin-top:12px;}
    th,td{padding:10px 8px; border-bottom:1px solid #e6e8f2; font-weight:900;}
    th{color:#6b7280; font-size:12px; text-align:left;}
    td{font-size:14px;}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topRow">
      <div>
        <div class="pageTitle">ピクシーインサイト</div>
        <div class="subtitle" id="monthSubtitle">12月のインサイト</div>
      </div>
      <div class="monthTabs" id="monthTabs"></div>
    </div>

    <div class="section card">
      <div class="kpiGrid">
        <div class="kpiLeft">
          <div class="label">今月の報酬金</div>
          <div class="big" id="kpiMoney">¥ 100,000</div>
          <div class="small">前月比 <span id="kpiMoM">101%</span></div>
        </div>
        <div class="kpiRight" id="tabDetail" role="button" aria-label="鑑定データ詳細を開く">
          <div class="title">鑑定データ詳細</div>
          <div class="miniGrid">
            <div class="mini">
              <div class="t">リピート件数</div>
              <div class="v" id="kpiRepeatCount">13</div>
            </div>
            <div class="mini">
              <div class="t">リピート人数</div>
              <div class="v" id="kpiRepeatUsers">9</div>
            </div>
            <div class="mini">
              <div class="t">鑑定件数</div>
              <div class="v" id="kpiKanteiCount">76</div>
            </div>
            <div class="mini">
              <div class="t">鑑定人数</div>
              <div class="v" id="kpiKanteiUsers">63</div>
            </div>
          </div>
        </div>
      </div>

      <div class="chartTabs" style="margin-top:18px">
        <button class="pill" id="tabHour">時間別</button>
        <button class="pill" id="tabWeek">曜日別</button>
        <button class="pill active" id="tabDay">日別</button>
      </div>

      <div class="chartWrap">
        <div class="chartViewport" id="chartViewport">
          <canvas id="chartCanvas" width="640" height="440"></canvas>

          <div class="yAxisLabels" id="yAxisLabels">
            <div id="yTop">417</div>
            <div id="yMid">818</div>
            <div id="yBot">1,218</div>
          </div>

          <div class="cursorLine hidden" id="cursorLine"></div>
          <div class="dot hidden" id="cursorDot"></div>

          <div class="tooltip hidden" id="tooltip">
            <div class="d" id="tipLabel">1日</div>
            <div class="m" id="tipMoney">¥ 577</div>
          </div>
        </div>
        <div class="xAxisLabels" id="xAxisLabels"></div>
      </div>
    </div>

    <div class="detailHeader" id="detailSection" style="margin-top:18px">詳細データ</div>
    <div class="detailTabs">
      <button class="pill active" id="tabUser">ユーザー分析</button>
      <button class="pill" id="tabKanteishi">鑑定師分析</button>
    </div>

    <div id="panelUser" class="panel">
      <div class="card">
        <div class="panelTitle">男女比率</div>
        <div class="ageRow">
          <div class="label">男性</div>
          <div class="barWrap"><div class="bar" id="barMale" style="width:0%"></div></div>
          <div class="pct" id="pctMale">0%</div>
        </div>
        <div class="ageRow">
          <div class="label">女性</div>
          <div class="barWrap"><div class="bar" id="barFemale" style="width:0%"></div></div>
          <div class="pct" id="pctFemale">0%</div>
        </div>

        <div style="margin-top:16px" class="panelTitle">年齢構成比</div>
        <div id="ageList"></div>
      </div>
    </div>

    <div id="panelKanteishi" class="hidden">
      <div class="card">
        <div class="panelTitle">鑑定師分析</div>
        <div class="subKpiGrid">
          <div class="subKpi">
            <div class="label">今月の報酬金</div>
            <div class="value" id="kpiKanteishiMoney">¥ 100,000</div>
          </div>
          <div class="subKpi">
            <div class="label">鑑定件数</div>
            <div class="value" id="kpiKanteishiCalls">76</div>
          </div>
          <div class="subKpi">
            <div class="label">平均単価</div>
            <div class="value" id="kpiKanteishiAvg">¥ 1,315</div>
          </div>
          <div class="subKpi">
            <div class="label">リピート率</div>
            <div class="value" id="kpiKanteishiRepeat">11.8%</div>
          </div>
        </div>
        <div class="subNote">※ここは「鑑定師ごとの数字」を出す場所。いまは動作確認用のサンプル表示です。</div>
      </div>
    </div>

    <div id="panelDetail" class="hidden panel">
      <div class="card">
        <div class="panelTitle">件数内訳（サンプル）</div>
        <div class="muted" style="margin-top:6px">2回目 / 3回目 / 4回目 / 5回以上 を見える化する予定の場所。</div>
        <table>
          <thead>
            <tr><th>回数</th><th>件数</th><th>割合</th></tr>
          </thead>
          <tbody id="countTableBody"></tbody>
        </table>
      </div>
    </div>

  </div>

  <script>
    // --- サンプルデータ（実データ連携の前にUIを固める用） ---
    var monthKeys = ["12月","11月","10月","9月"];
    var dataByMonth = {
      "12月":{
        money:100000,
        mom:101,
        repeatCount:13, repeatUsers:9, kanteiCount:76, kanteiUsers:63,
        gender:{male:20,female:80},
        ages:[
          {label:"-29", pct:12},
          {label:"30-39", pct:24},
          {label:"40-49", pct:28},
          {label:"50-59", pct:20},
          {label:"60-69", pct:10},
          {label:"70-", pct:6}
        ],
        chart:{
          day: Array.from({length:31}, (_,i)=>({x:i+1, y: 550 + Math.round(420*Math.sin((i/31)*Math.PI*1.6) + 180*Math.cos((i/31)*Math.PI*2.2))})),
          week: [
            {x:"月",y:720},{x:"火",y:880},{x:"水",y:810},{x:"木",y:740},{x:"金",y:1020},{x:"土",y:930},{x:"日",y:860}
          ],
          hour: Array.from({length:24}, (_,i)=>({x:i, y: 400 + Math.round(650*Math.max(0,Math.sin((i-6)/24*Math.PI*2)))}))
        }
      },
      "11月":{
        money:99000,
        mom:98,
        repeatCount:11, repeatUsers:8, kanteiCount:72, kanteiUsers:60,
        gender:{male:22,female:78},
        ages:[
          {label:"-29", pct:13},
          {label:"30-39", pct:22},
          {label:"40-49", pct:29},
          {label:"50-59", pct:18},
          {label:"60-69", pct:12},
          {label:"70-", pct:6}
        ],
        chart:{
          day: Array.from({length:30}, (_,i)=>({x:i+1, y: 520 + Math.round(380*Math.sin((i/30)*Math.PI*1.8) + 200*Math.cos((i/30)*Math.PI*2.0))})),
          week: [
            {x:"月",y:690},{x:"火",y:820},{x:"水",y:760},{x:"木",y:710},{x:"金",y:940},{x:"土",y:910},{x:"日",y:830}
          ],
          hour: Array.from({length:24}, (_,i)=>({x:i, y: 380 + Math.round(620*Math.max(0,Math.sin((i-6)/24*Math.PI*2)))}))
        }
      },
      "10月":{
        money:102000,
        mom:105,
        repeatCount:14, repeatUsers:10, kanteiCount:80, kanteiUsers:66,
        gender:{male:18,female:82},
        ages:[
          {label:"-29", pct:10},
          {label:"30-39", pct:23},
          {label:"40-49", pct:31},
          {label:"50-59", pct:19},
          {label:"60-69", pct:11},
          {label:"70-", pct:6}
        ],
        chart:{
          day: Array.from({length:31}, (_,i)=>({x:i+1, y: 580 + Math.round(460*Math.sin((i/31)*Math.PI*1.5) + 160*Math.cos((i/31)*Math.PI*2.1))})),
          week: [
            {x:"月",y:740},{x:"火",y:860},{x:"水",y:800},{x:"木",y:760},{x:"金",y:980},{x:"土",y:920},{x:"日",y:850}
          ],
          hour: Array.from({length:24}, (_,i)=>({x:i, y: 420 + Math.round(680*Math.max(0,Math.sin((i-6)/24*Math.PI*2)))}))
        }
      },
      "9月":{
        money:96000,
        mom:97,
        repeatCount:10, repeatUsers:7, kanteiCount:70, kanteiUsers:58,
        gender:{male:24,female:76},
        ages:[
          {label:"-29", pct:14},
          {label:"30-39", pct:26},
          {label:"40-49", pct:27},
          {label:"50-59", pct:18},
          {label:"60-69", pct:10},
          {label:"70-", pct:5}
        ],
        chart:{
          day: Array.from({length:30}, (_,i)=>({x:i+1, y: 540 + Math.round(420*Math.sin((i/30)*Math.PI*1.7) + 180*Math.cos((i/30)*Math.PI*2.4))})),
          week: [
            {x:"月",y:710},{x:"火",y:840},{x:"水",y:780},{x:"木",y:730},{x:"金",y:950},{x:"土",y:900},{x:"日",y:820}
          ],
          hour: Array.from({length:24}, (_,i)=>({x:i, y: 390 + Math.round(610*Math.max(0,Math.sin((i-6)/24*Math.PI*2)))}))
        }
      }
    };

    function yen(n){
      var s = Math.round(n).toString();
      return "¥ " + s.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    // --- 月タブ ---
    var monthTabs = document.getElementById("monthTabs");
    var monthSubtitle = document.getElementById("monthSubtitle");

    var state = {
      monthKey:"12月",
      mode:"day", // day / week / hour
      cursorIndex: 0,
      mainView:"main", // main / detail
      detailTab:"user" // user / kanteishi
    };

    function renderMonthTabs(){
      monthTabs.innerHTML = "";
      monthKeys.forEach(function(k){
        var b = document.createElement("button");
        b.className = "pill" + (k===state.monthKey ? " active" : "");
        b.textContent = k;
        b.addEventListener("click", function(){
          state.monthKey = k;
          monthSubtitle.textContent = k + "のインサイト";
          renderAll();
          renderMonthTabs();
        });
        monthTabs.appendChild(b);
      });
    }

    // --- KPI ---
    var kpiMoney = document.getElementById("kpiMoney");
    var kpiMoM = document.getElementById("kpiMoM");
    var kpiRepeatCount = document.getElementById("kpiRepeatCount");
    var kpiRepeatUsers = document.getElementById("kpiRepeatUsers");
    var kpiKanteiCount = document.getElementById("kpiKanteiCount");
    var kpiKanteiUsers = document.getElementById("kpiKanteiUsers");

    function renderKpi(){
      var m = dataByMonth[state.monthKey];
      kpiMoney.textContent = yen(m.money);
      kpiMoM.textContent = String(m.mom) + "%";
      kpiRepeatCount.textContent = String(m.repeatCount);
      kpiRepeatUsers.textContent = String(m.repeatUsers);
      kpiKanteiCount.textContent = String(m.kanteiCount);
      kpiKanteiUsers.textContent = String(m.kanteiUsers);
    }

      function renderKanteishiPanel(){
        var m = dataByMonth[state.monthKey];
        var km = document.getElementById("kpiKanteishiMoney");
        var kc = document.getElementById("kpiKanteishiCalls");
        var ka = document.getElementById("kpiKanteishiAvg");
        var kr = document.getElementById("kpiKanteishiRepeat");
        if(!m) return;
        if(km) km.textContent = yen(m.money);
        if(kc) kc.textContent = String(m.kanteiCount);
        if(ka){
          var avg = (m.kanteiCount>0) ? Math.round(m.money / m.kanteiCount) : 0;
          ka.textContent = yen(avg);
        }
        if(kr){
          var rate = (m.kanteiCount>0) ? (m.repeatCount / m.kanteiCount * 100) : 0;
          kr.textContent = (Math.round(rate*10)/10).toFixed(1) + "%";
        }
      }

    // --- チャートタブ ---
    var tabHour = document.getElementById("tabHour");
    var tabWeek = document.getElementById("tabWeek");
    var tabDay  = document.getElementById("tabDay");

    function setChartMode(mode){
      state.mode = mode;
      tabHour.classList.toggle("active", mode==="hour");
      tabWeek.classList.toggle("active", mode==="week");
      tabDay.classList.toggle("active", mode==="day");
      state.cursorIndex = 0;
      drawChart();
    }

    tabHour.addEventListener("click", function(){ setChartMode("hour"); });
    tabWeek.addEventListener("click", function(){ setChartMode("week"); });
    tabDay.addEventListener("click", function(){ setChartMode("day"); });

    // --- 詳細タブ ---
    var tabUser = document.getElementById("tabUser");
    var tabKanteishi = document.getElementById("tabKanteishi");

    var panelUser = document.getElementById("panelUser");
    var panelKanteishi = document.getElementById("panelKanteishi");
    var panelDetail = document.getElementById("panelDetail");
    var tabDetail = document.getElementById("tabDetail");

    function setDetailTab(which){
      state.detailTab = which;
      tabUser.classList.toggle("active", which==="user");
      tabKanteishi.classList.toggle("active", which==="kanteishi");
      panelUser.classList.toggle("hidden", which!=="user");
      panelKanteishi.classList.toggle("hidden", which!=="kanteishi");
    }

    tabUser.addEventListener("click", function(){ setDetailTab("user"); });
    tabKanteishi.addEventListener("click", function(){ setDetailTab("kanteishi"); });

    function setMainView(view){
      state.mainView = view;
      panelDetail.classList.toggle("hidden", view!=="detail");
    }

    tabDetail.addEventListener("click", function(){
        setMainView("detail");
        renderCountTable();
        var a = document.getElementById("detailSection");
        if(a) a.scrollIntoView({behavior:"smooth", block:"start"});
      });

    // --- ユーザー分析描画 ---
    var barMale = document.getElementById("barMale");
    var barFemale = document.getElementById("barFemale");
    var pctMale = document.getElementById("pctMale");
    var pctFemale = document.getElementById("pctFemale");
    var ageList = document.getElementById("ageList");

    function renderUserPanels(){
      var m = dataByMonth[state.monthKey];
      barMale.style.width = m.gender.male + "%";
      barFemale.style.width = m.gender.female + "%";
      pctMale.textContent = m.gender.male + "%";
      pctFemale.textContent = m.gender.female + "%";

      ageList.innerHTML = "";
      m.ages.forEach(function(a){
        var row = document.createElement("div");
        row.className = "ageRow";
        row.innerHTML = '<div class="label">'+a.label+'</div>'
          + '<div class="barWrap"><div class="bar" style="width:'+a.pct+'%"></div></div>'
          + '<div class="pct">'+a.pct+'%</div>';
        ageList.appendChild(row);
      });
    }

    // --- 件数内訳（サンプル） ---
    var countTableBody = document.getElementById("countTableBody");
    function renderCountTable(){
      var m = dataByMonth[state.monthKey];
      // ここは本来: phone_kantei_historyから「何回目で終わったか」を集計する
      // いまは見た目確認のサンプル
      var total = Math.max(1, m.kanteiCount);
      var rows = [
        {k:"1回", v: Math.round(total*0.65)},
        {k:"2回", v: Math.round(total*0.18)},
        {k:"3回", v: Math.round(total*0.08)},
        {k:"4回", v: Math.round(total*0.05)},
        {k:"5回以上", v: Math.round(total*0.04)}
      ];
      // 端数調整
      var sum = rows.reduce((s,r)=>s+r.v,0);
      rows[0].v += (total - sum);

      countTableBody.innerHTML = "";
      rows.forEach(function(r){
        var tr = document.createElement("tr");
        var pct = (r.v/total*100);
        tr.innerHTML = "<td>"+r.k+"</td><td>"+r.v+"</td><td>"+(Math.round(pct*10)/10).toFixed(1)+"%</td>";
        countTableBody.appendChild(tr);
      });
    }

    // --- チャート描画 ---
    var chartViewport = document.getElementById("chartViewport");
    var canvas = document.getElementById("chartCanvas");
    var ctx = canvas.getContext("2d");

    var yTop = document.getElementById("yTop");
    var yMid = document.getElementById("yMid");
    var yBot = document.getElementById("yBot");

    var xAxisLabels = document.getElementById("xAxisLabels");
    var cursorLine = document.getElementById("cursorLine");
    var cursorDot = document.getElementById("cursorDot");
    var tooltip = document.getElementById("tooltip");
    var tipLabel = document.getElementById("tipLabel");
    var tipMoney = document.getElementById("tipMoney");

    var chartGeom = { padL:14, padR:54, padT:12, padB:34, w:0, h:0, plotW:0, plotH:0, n:0 };

      function buildXAxisTicks(labels){
        var n = labels.length;
        var maxTicks = 7;
        if(n<=maxTicks){
          var out = [];
          for(var i=0;i<n;i++) out.push({label: labels[i], idx:i});
          return out;
        }
        var idxs = [];
        for(var k=0;k<maxTicks;k++){
          var idx = Math.round((n-1) * (k/(maxTicks-1)));
          idxs.push(idx);
        }
        // uniq + sort
        idxs = idxs.filter(function(v,i,a){ return a.indexOf(v)===i; }).sort(function(a,b){return a-b;});
        // ensure first/last
        if(idxs[0]!==0) idxs.unshift(0);
        if(idxs[idxs.length-1]!==n-1) idxs.push(n-1);
        var ticks = [];
        for(var t=0;t<idxs.length;t++){
          ticks.push({label: labels[idxs[t]], idx: idxs[t]});
        }
        return ticks;
      }

    function getSeries(){
      var m = dataByMonth[state.monthKey];
      if(state.mode==="day"){
        return {
          labels: m.chart.day.map(d=>d.x+"日"),
          values: m.chart.day.map(d=>d.y),
          rawLabels: m.chart.day.map(d=>d.x)
        };
      }
      if(state.mode==="week"){
        return {
          labels: m.chart.week.map(d=>d.x),
          values: m.chart.week.map(d=>d.y),
          rawLabels: m.chart.week.map(d=>d.x)
        };
      }
      // hour
      return {
        labels: m.chart.hour.map(d=>d.x+"時"),
        values: m.chart.hour.map(d=>d.y),
        rawLabels: m.chart.hour.map(d=>d.x)
      };
    }

    function resizeCanvas(){
      var rect = chartViewport.getBoundingClientRect();
      var dpr = window.devicePixelRatio || 1;
      canvas.width = Math.round(rect.width * dpr);
      canvas.height = Math.round(rect.height * dpr);
      canvas.style.width = rect.width + "px";
      canvas.style.height = rect.height + "px";
      ctx.setTransform(dpr,0,0,dpr,0,0);

      chartGeom.w = rect.width;
      chartGeom.h = rect.height;
      chartGeom.plotW = rect.width - chartGeom.padL - chartGeom.padR;
      chartGeom.plotH = rect.height - chartGeom.padT - chartGeom.padB;
    }

    function drawChart(){
      resizeCanvas();
      var s = getSeries();
      var values = s.values;
      var labels = s.labels;
      var n = values.length;
      chartGeom.n = n;

      // axis range
      var min = Math.min.apply(null, values);
      var max = Math.max.apply(null, values);
      if(min===max){ max = min + 1; }
      // padding
      var pad = (max-min)*0.15;
      var vMin = Math.max(0, min - pad);
      var vMax = max + pad;

      // y labels (top/mid/bot)
      var topV = Math.round(vMin + (vMax-vMin)*0.2);
      var midV = Math.round(vMin + (vMax-vMin)*0.55);
      var botV = Math.round(vMin + (vMax-vMin)*0.9);
      yTop.textContent = topV.toLocaleString();
      yMid.textContent = midV.toLocaleString();
      yBot.textContent = botV.toLocaleString();

      // x axis labels: 点の位置に合わせて絶対配置
      var ticks = buildXAxisTicks(labels);
      xAxisLabels.innerHTML = "";
      for(var i=0;i<ticks.length;i++){
        var t = ticks[i];
        var sp = document.createElement("span");
        sp.textContent = t.label;
        sp.className = (i===0 ? "first" : "") + (i===ticks.length-1 ? " last" : "");
        var x = chartGeom.padL + chartGeom.plotW * (t.idx / Math.max(1,(n-1)));
        sp.style.left = x + "px";
        xAxisLabels.appendChild(sp);
      }

      function xAt(i){
        if(n<=1) return chartGeom.padL;
        return chartGeom.padL + chartGeom.plotW * (i/(n-1));
      }
      function yAt(v){
        var t = (v - vMin) / (vMax - vMin);
        t = Math.max(0, Math.min(1, t));
        return chartGeom.padT + chartGeom.plotH * (1 - t);
      }

      // clear
      ctx.clearRect(0,0,chartGeom.w, chartGeom.h);

      // gridlines
      ctx.save();
      ctx.strokeStyle = "rgba(0,0,0,0.06)";
      ctx.lineWidth = 1;
      var gridYs = [0.2,0.55,0.9].map(function(r){ return chartGeom.padT + chartGeom.plotH*r; });
      gridYs.forEach(function(gy){
        ctx.beginPath();
        ctx.moveTo(chartGeom.padL, gy);
        ctx.lineTo(chartGeom.w - chartGeom.padR, gy);
        ctx.stroke();
      });
      ctx.restore();

      // line
      ctx.save();
      ctx.strokeStyle = "#2f6df6";
      ctx.lineWidth = 4;
      ctx.lineJoin = "round";
      ctx.lineCap = "round";

      ctx.beginPath();
      for(var i=0;i<n;i++){
        var x = xAt(i);
        var y = yAt(values[i]);
        if(i===0) ctx.moveTo(x,y);
        else ctx.lineTo(x,y);
      }
      ctx.stroke();
      ctx.restore();

      // cursor + tooltip
      if(state.cursorIndex != null && state.cursorIndex >= 0){
        var idx = Math.max(0, Math.min(n-1, state.cursorIndex));
        var cx = xAt(idx);
        var cy = yAt(values[idx]);

        cursorLine.classList.remove("hidden");
        cursorDot.classList.remove("hidden");
        tooltip.classList.remove("hidden");

        cursorLine.style.left = cx + "px";
        cursorDot.style.left = cx + "px";
        cursorDot.style.top = cy + "px";

        // tooltip text
        tipLabel.textContent = labels[idx];
        tipMoney.textContent = yen(values[idx]);

        // tooltip position (keep inside)
        var tw = 110;
        var left = Math.max(8, Math.min(chartGeom.w - tw - 8, cx - 10));
        tooltip.style.left = left + "px";
        tooltip.style.top = "18px";
      }else{
        cursorLine.classList.add("hidden");
        cursorDot.classList.add("hidden");
        tooltip.classList.add("hidden");
      }
    }

    // pointer/touch drag
    var dragging = false;

    function indexFromClientX(clientX){
      var rect = chartViewport.getBoundingClientRect();
      var x = clientX - rect.left;
      x = Math.max(chartGeom.padL, Math.min(chartGeom.w - chartGeom.padR, x));
      var t = (x - chartGeom.padL) / Math.max(1, chartGeom.plotW);
      var s = getSeries();
      var n = s.values.length;
      if(n<=1) return 0;
      return Math.round(t * (n-1));
    }

    chartViewport.addEventListener("pointerdown", function(e){
      dragging = true;
      try{ chartViewport.setPointerCapture(e.pointerId); }catch(_){}
      state.cursorIndex = indexFromClientX(e.clientX);
      if(e.cancelable) e.preventDefault();
      drawChart();
    });

    window.addEventListener("pointermove", function(e){
      if(!dragging) return;
      state.cursorIndex = indexFromClientX(e.clientX);
      if(e.cancelable) e.preventDefault();
      drawChart();
    });

    function endDrag(e){
        dragging = false;
        try{ chartViewport.releasePointerCapture(e.pointerId); }catch(_){}
        if(e && e.cancelable) e.preventDefault();
      }
    chartViewport.addEventListener("pointerup", endDrag);
    chartViewport.addEventListener("pointercancel", endDrag);

      // iPhone向け: touchでもスライドできるようにする（pointerが不安定なときの保険）
      chartViewport.addEventListener("touchstart", function(ev){
        if(!ev.touches || ev.touches.length===0) return;
        dragging = true;
        var t = ev.touches[0];
        state.cursorIndex = indexFromClientX(t.clientX);
        if(ev.cancelable) ev.preventDefault();
        drawChart();
      }, {passive:false});

      chartViewport.addEventListener("touchmove", function(ev){
        if(!dragging) return;
        if(!ev.touches || ev.touches.length===0) return;
        var t = ev.touches[0];
        state.cursorIndex = indexFromClientX(t.clientX);
        if(ev.cancelable) ev.preventDefault();
        drawChart();
      }, {passive:false});

      chartViewport.addEventListener("touchend", function(ev){
        dragging = false;
        if(ev.cancelable) ev.preventDefault();
      }, {passive:false});

    // init
    function renderAll(){
      renderKpi();
      renderUserPanels();
      renderKanteishiPanel();
      drawChart();
      if(state.mainView==="detail") renderCountTable();
    }

    renderMonthTabs();
    setDetailTab("user");
    setChartMode("day");
    renderAll();
    window.addEventListener("resize", function(){ drawChart(); });
  </script>
</body>
</html>
