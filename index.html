<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Pixy インサイト（UI）</title>
  <style>
    :root{
      --bg:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --line:#f3a6c8;
      --chip:#e5e7eb;
      --chipText:#111827;
      --chipActive:#111111;
      --chipActiveText:#ffffff;
      --card:#ffffff;
      --cardBorder:#d1d5db;
      --cardActiveBg:#fde7ef;
      --cardActiveBorder:#f3a6c8;
      --shadow: 0 8px 20px rgba(0,0,0,.08);
      --radius: 14px;
      --blue:#2563eb;
      --pink:#ff4db8;
      --grid:#e5e7eb;
      --danger:#ff4d4f;
    }
    *{box-sizing:border-box;}
    html,body{height:100%;}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans JP", "Hiragino Kaku Gothic ProN", "Meiryo", Arial, sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    a{color:inherit;}
    .wrap{ max-width: 420px; margin:0 auto; padding: 10px 12px 28px; }
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      padding: 4px 2px 8px; position: sticky; top: 0; background: var(--bg); z-index: 30;
    }
    .logo{ font-weight:700; letter-spacing:.02em; font-size: 18px; }
    .title{ font-size: 18px; font-weight:700; text-align:center; flex:1; }
    .spacer{width:48px;}
    .pinkline{ height:2px; background: var(--line); border-radius:999px; margin: 0 0 10px; opacity:.75; }
    .label{ font-size: 13px; color: var(--text); margin: 6px 0 6px; font-weight:600; }
    .input{
      width:100%; border:0; border-bottom:2px solid var(--line);
      padding:10px 2px 10px; font-size:16px; outline:none; background:transparent;
    }

    .chipRow{
      display:flex; gap:8px; overflow:auto; padding:10px 0 2px;
      -webkit-overflow-scrolling: touch; scrollbar-width: none;
    }
    .chipRow::-webkit-scrollbar{ display:none; }
    .chip{
      border:0; padding:8px 14px; border-radius:999px;
      background:var(--chip); color:var(--chipText);
      font-weight:700; font-size:13px; cursor:pointer; white-space:nowrap;
      flex:0 0 auto; transition: transform .08s ease;
    }
    .chip:active{ transform: scale(.98); }
    .chip.active{ background:var(--chipActive); color:var(--chipActiveText); }

    .sectionTitle{ display:flex; align-items:flex-end; justify-content:space-between; gap:10px; margin-top: 10px; }
    .sectionTitle h2{ margin:0; font-size: 18px; font-weight:800; letter-spacing:.01em; }
    .divider{ height:2px; background: var(--line); border-radius:999px; margin: 6px 0 10px; opacity:.75; }

    .cards{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .card{
      border: 1.5px solid var(--cardBorder); background: var(--card);
      border-radius: 12px; padding: 10px; cursor:pointer;
      transition: transform .08s ease, border-color .15s ease, background .15s ease;
      min-height: 88px; position:relative;
    }
    .card:active{ transform: scale(.99); }
    .card.active{ border-color: var(--cardActiveBorder); background: var(--cardActiveBg); }
    .card .kpiTitle{ font-size: 12px; color: var(--muted); font-weight:700; margin-bottom: 6px; }
    .card .kpiValue{ font-size: 20px; font-weight:900; margin-bottom: 2px; }
    .card .kpiSub{ font-size: 12px; color: var(--muted); font-weight:700; }

    .miniGrid{ display:grid; grid-template-columns: 1fr 1fr; gap: 6px 10px; margin-top: 6px; align-items:end; }
    .miniItem .miniLabel{ font-size: 10px; color: var(--muted); font-weight:700; line-height:1.1; }
    .miniItem .miniVal{ font-size: 16px; font-weight:900; margin-top:2px; line-height:1.1; }

    .toggleRow{ display:flex; gap:8px; margin: 10px 0 8px; }
    .toggle{
      border:0; background: var(--chip); color: var(--chipText);
      font-weight:800; font-size: 13px; padding:8px 12px; border-radius: 999px;
      cursor:pointer; transition: transform .08s ease;
    }
    .toggle:active{ transform: scale(.98); }
    .toggle.active{ background: #4b5563; color:#fff; }

    .chartCard{
      border-radius: var(--radius); background:#fff; box-shadow: var(--shadow);
      padding: 10px 10px 8px; position:relative; overflow:hidden;
    }
    .chartWrap{ position:relative; height: 180px; margin-top: 4px; border-radius: 12px; background: #ffffff; overflow:hidden; }

    /* 横スクロール（スマホは指で、PCはホイール/トラックパッド/ドラッグで） */
    .chartViewport{
      position:absolute; left:0; right:0; top:0; bottom:28px;
      overflow-x:auto; overflow-y:hidden;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      cursor: grab;
    }
    .chartViewport:active{ cursor: grabbing; }
    .chartViewport::-webkit-scrollbar{ display:none; }

    .chartInner{ position:relative; height:100%; width: 100%; }
    canvas{display:block; width:100%; height:100%;}

    .yLabels{
      position:absolute; right: 6px; top: 4px; bottom: 28px;
      display:flex; flex-direction:column; justify-content:space-between;
      pointer-events:none; font-size: 11px; color: var(--muted); font-weight:700; opacity:.9;
      z-index: 5;
      background: linear-gradient(90deg, rgba(255,255,255,0), rgba(255,255,255,.92) 25%, rgba(255,255,255,1) 60%);
      padding-left: 16px;
    }

    .cursorLine{
      position:absolute; top: 8px; bottom: 8px; width:2px;
      background: rgba(37,99,235,.55); border-radius:999px;
      pointer-events:none; display:none; z-index: 3;
    }
    .tooltip{
      position:absolute; min-width: 90px; padding: 8px 10px;
      background:#fff; border:1px solid rgba(0,0,0,.08); box-shadow: 0 10px 30px rgba(0,0,0,.12);
      border-radius: 10px; font-size: 12px; font-weight:800; color: var(--text);
      transform: translate(-50%, -110%); pointer-events:none; display:none; white-space:nowrap; z-index: 4;
    }
    .tooltip .tLabel{ font-weight:900; margin-bottom: 2px; color: var(--text); }
    .tooltip .tVal{ font-weight:900; color: var(--muted); }

    .xLabelsViewport{ margin-top: 8px; overflow-x:auto; -webkit-overflow-scrolling: touch; scrollbar-width: none; }
    .xLabelsViewport::-webkit-scrollbar{ display:none; }
    .xLabels{
      display:flex; gap:0; user-select:none; font-size: 12px; color: var(--muted);
      font-weight:700; padding: 0 2px; white-space:nowrap;
    }
    .xLabels span{
      flex: 0 0 var(--slot, 64px); text-align:center; overflow:hidden; text-overflow:ellipsis;
    }

    .detailTabs{ display:flex; gap:8px; margin: 10px 0 10px; }
    .tab{ border:0; padding: 8px 14px; border-radius: 999px; background: var(--chip); color: var(--chipText); font-weight:900; font-size: 13px; cursor:pointer; }
    .tab.active{ background:#4b5563; color:#fff; }

    .panel{ background:#fff; border-radius: var(--radius); box-shadow: var(--shadow); padding: 12px; }
    .panel + .panel{ margin-top: 10px; }

    .subSection{ margin-top: 6px; font-size: 13px; font-weight:900; color: var(--text); display:flex; align-items:center; gap:8px; }
    .dot{ width:10px; height:10px; border-radius:2px; background: var(--blue); flex:0 0 auto; }

    .rows{ margin-top: 8px; border-top:1px solid rgba(0,0,0,.06); }
    .row{
      display:flex; justify-content:space-between; align-items:center;
      padding: 8px 0; border-bottom:1px solid rgba(0,0,0,.06);
      font-size: 13px; font-weight:700; color: var(--text);
    }
    .row .rVal{ color: var(--text); font-weight:900; }

    .barItem{ margin-top: 10px; }
    .barTop{ display:flex; justify-content:space-between; gap:8px; font-size: 12px; font-weight:800; color: var(--text); }
    .barBg{ height: 10px; background: #e5e7eb; border-radius: 999px; overflow:hidden; margin-top: 6px; }
    .barFill{ height: 100%; background: var(--blue); width: 0%; border-radius: 999px; }

    .genderBar{ margin-top: 10px; }
    .genderTrack{ height: 10px; background: #e5e7eb; border-radius: 999px; overflow:hidden; display:flex; }
    .genderFemale{ background: var(--pink); }
    .genderMale{ background: var(--blue); }
    .genderLabels{ margin-top: 8px; display:flex; justify-content:space-between; font-size: 12px; color: var(--text); font-weight:800; }
    .muted{ color: var(--muted); font-weight:700; }

    .p2Box{ background:#fff; border-radius: var(--radius); box-shadow: var(--shadow); padding: 12px; margin-top: 10px; }
    .p2Title{ font-size: 13px; font-weight: 900; margin: 0 0 10px; }
    .p2TableHeader{
      display:grid; grid-template-columns: 64px 1fr 56px 56px; gap: 8px;
      font-size: 11px; color: var(--muted); font-weight: 900;
      padding-bottom: 6px; border-bottom: 1px solid rgba(0,0,0,.06);
    }
    .p2Row{
      display:grid; grid-template-columns: 64px 1fr 56px 56px; gap: 8px;
      align-items:center; padding: 8px 0; border-bottom: 1px solid rgba(0,0,0,.06);
      font-size: 12px; font-weight: 800;
    }
    .p2BarBg{ height: 8px; background:#e5e7eb; border-radius:999px; overflow:hidden; }
    .p2BarFill{ height: 100%; background: var(--blue); width: 0%; border-radius:999px; }

    .ctaRow{ display:flex; justify-content:flex-end; margin-top: 12px; }
    .cta{
      display:inline-flex; align-items:center; justify-content:center; border:0;
      padding: 10px 18px; border-radius: 999px; background: var(--danger); color:#fff;
      font-weight: 900; font-size: 14px; text-decoration:none; min-width: 140px;
      box-shadow: 0 10px 18px rgba(255,77,79,.25); transition: transform .08s ease;
    }
    .cta:active{ transform: scale(.99); }
    .hidden{ display:none !important; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="logo">Pixy</div>
      <div class="title">インサイト</div>
      <div class="spacer"></div>
    </div>
    <div class="pinkline"></div>

    <div class="label">鑑定師名</div>
    <input id="readerName" class="input" placeholder="例：インイン" list="nameList" />
    <datalist id="nameList">
      <option value="インイン"></option>
      <option value="ササイ"></option>
      <option value="イトト"></option>
    </datalist>

    <div class="chipRow" id="monthRow" aria-label="月選択"></div>

    <div class="sectionTitle">
      <h2>メインデータ</h2>
    </div>
    <div class="divider"></div>

    <div class="cards" role="tablist" aria-label="メイン切替">
      <button class="card active" id="tabKpi" role="tab" aria-selected="true">
        <div class="kpiTitle">今月の報酬金</div>
        <div class="kpiValue" id="kpiMoney">¥ 100,000</div>
        <div class="kpiSub">前月比　<span id="kpiMoM">101%</span></div>
      </button>
      <button class="card" id="tabDetail" role="tab" aria-selected="false">
        <div class="kpiTitle">鑑定データ詳細</div>
        <div class="miniGrid">
          <div class="miniItem">
            <div class="miniLabel">リピート件数</div>
            <div class="miniVal" id="kpiRepeatCnt">13</div>
          </div>
          <div class="miniItem" style="text-align:right">
            <div class="miniLabel">リピート人数</div>
            <div class="miniVal" id="kpiRepeatUsers">9</div>
          </div>
          <div class="miniItem">
            <div class="miniLabel">鑑定件数</div>
            <div class="miniVal" id="kpiKanteiCnt">76</div>
          </div>
          <div class="miniItem" style="text-align:right">
            <div class="miniLabel">鑑定人数</div>
            <div class="miniVal" id="kpiKanteiUsers">63</div>
          </div>
        </div>
      </button>
    </div>

    <div id="viewKpi">
      <div class="toggleRow" aria-label="グラフ切替">
        <button class="toggle active" data-mode="hour">時間別</button>
        <button class="toggle" data-mode="weekday">曜日別</button>
        <button class="toggle" data-mode="day">日別</button>
      </div>

      <div class="chartCard">
        <div class="chartWrap">
          <div class="chartViewport" id="chartViewport">
            <div class="chartInner" id="chartInner">
              <canvas id="chart"></canvas>
              <div class="cursorLine" id="cursorLine"></div>
              <div class="tooltip" id="tooltip">
                <div class="tLabel" id="tipLabel">02時</div>
                <div class="tVal" id="tipValue">¥ 800</div>
              </div>
            </div>
          </div>

          <div class="yLabels">
            <div id="yTop">1,155</div>
            <div id="yMid">770</div>
            <div id="yBot">385</div>
          </div>
        </div>

        <div class="xLabelsViewport" id="xLabelsViewport">
          <div class="xLabels" id="xLabels"></div>
        </div>
      </div>

      <div class="sectionTitle" style="margin-top:14px;">
        <h2>詳細データ</h2>
      </div>
      <div class="divider"></div>

      <div class="detailTabs">
        <button class="tab active" data-detail="user">ユーザー分析</button>
        <button class="tab" data-detail="reader">鑑定師分析</button>
      </div>

      <div id="panelUser" class="panel">
        <div class="subSection"><span class="dot"></span>年齢構成比</div>
        <div id="ageList"></div>

        <div class="subSection" style="margin-top:14px;"><span class="dot"></span>男女比率</div>
        <div class="genderBar">
          <div class="genderTrack">
            <div class="genderFemale" id="femaleBar" style="width:10%"></div>
            <div class="genderMale" id="maleBar" style="width:90%"></div>
          </div>
          <div class="genderLabels">
            <div>女性　<span class="muted" id="femalePct">10%</span></div>
            <div>男性　<span class="muted" id="malePct">90%</span></div>
          </div>
        </div>
      </div>

      <div id="panelReader" class="panel hidden">
        <div class="subSection"><span class="dot"></span>待機時間</div>
        <div class="rows">
          <div class="row"><div class="rLabel">今月の待機時間</div><div class="rVal" id="waitThis">100h</div></div>
          <div class="row"><div class="rLabel">前月の待機時間</div><div class="rVal" id="waitPrev">110h</div></div>
          <div class="row"><div class="rLabel">前月比</div><div class="rVal" id="waitMoM">90%</div></div>
        </div>

        <div class="subSection" style="margin-top:12px;"><span class="dot" style="background:#22c55e"></span>アフターメッセージ</div>
        <div class="rows">
          <div class="row"><div class="rLabel">鑑定件数</div><div class="rVal" id="amTotal">10</div></div>
          <div class="row"><div class="rLabel">送信数</div><div class="rVal" id="amSent">6</div></div>
          <div class="row"><div class="rLabel">未送信</div><div class="rVal" id="amUnsent">4</div></div>
          <div class="row"><div class="rLabel">送信率</div><div class="rVal" id="amRate">60%</div></div>
        </div>
      </div>
    </div>

    <div id="viewDetail" class="hidden">
      <div class="p2Box">
        <div class="p2Title">回数別ユーザー数</div>
        <div class="p2TableHeader">
          <div>区分</div>
          <div></div>
          <div style="text-align:right;">人数</div>
          <div style="text-align:right;">割合</div>
        </div>
        <div id="p2Rows"></div>

        <div class="ctaRow">
          <a class="cta" href="https://kuboizaizen.github.io/shino-insight/" target="_blank" rel="noopener noreferrer">詳細を確認</a>
        </div>
      </div>
    </div>

    <div style="height:12px"></div>
  </div>

<script>
  function makeSeries(count, base, wobble){
    const arr = [];
    for(let i=0;i<count;i++){
      const t = Math.sin((i/count) * Math.PI * 2) * wobble;
      const j = (Math.cos((i/count) * Math.PI * 4) * wobble*0.4);
      const v = Math.max(50, Math.round(base + t + j + (Math.random()-0.5)*wobble*0.35));
      arr.push(v);
    }
    return arr;
  }
  function hourLabels(){ const a=[]; for(let i=0;i<24;i++) a.push(i.toString().padStart(2,"0")+"時"); return a; }
  function dayLabels(){ const a=[]; for(let i=1;i<=31;i++) a.push(i+"日"); return a; }
  function weekLabels(){ return ["日","月","火","水","木","金","土"]; }

  const APP = {
    months: ["12月","11月","10月","9月","8月"],
    state: { month: "12月", mainTab: "kpi", chartMode: "hour", detailTab: "user", cursorIndex: null },
    dataByMonth: {
      "12月": {
        money: 100000, mom: 101,
        repeatCnt: 13, repeatUsers: 9, kanteiCnt: 76, kanteiUsers: 63,
        chart: {
          hour: { labels: hourLabels(), values: makeSeries(24, 650, 420) },
          weekday: { labels: weekLabels(), values: makeSeries(7, 720, 300) },
          day: { labels: dayLabels(), values: makeSeries(31, 680, 520) }
        },
        user: {
          age: [
            { label:"18 - 24", pct:41.9 },
            { label:"25 - 34", pct:30.9 },
            { label:"35 - 44", pct:12.7 },
            { label:"45 - 54", pct:9.9 }
          ],
          gender: { female: 10, male: 90 }
        },
        reader: {
          waitThis: 100, waitPrev: 110, waitMoM: 90,
          after: { total: 10, sent: 6, unsent: 4, rate: 60 }
        },
        p2: {
          counts: [
            { label:"1回", n:54, pct:85.7 },
            { label:"2回", n:5, pct:7.9 },
            { label:"3回", n:4, pct:6.3 },
            { label:"4回", n:0, pct:0.0 },
            { label:"5回以上", n:0, pct:0.0 }
          ]
        }
      }
    }
  };

  (function fillOtherMonths(){
    const base = APP.dataByMonth["12月"];
    const monthDefs = {
      "11月": { money: 98000, mom: 97, bump:-60 },
      "10月": { money: 102000, mom: 104, bump:+40 },
      "9月": { money: 96000, mom: 92, bump:-120 },
      "8月": { money: 104000, mom: 110, bump:+90 }
    };
    Object.entries(monthDefs).forEach(([m,def])=>{
      APP.dataByMonth[m] = JSON.parse(JSON.stringify(base));
      APP.dataByMonth[m].money = def.money;
      APP.dataByMonth[m].mom = def.mom;
      APP.dataByMonth[m].chart.hour.values = makeSeries(24, 650+def.bump, 420);
      APP.dataByMonth[m].chart.weekday.values = makeSeries(7, 720+def.bump*0.5, 300);
      APP.dataByMonth[m].chart.day.values = makeSeries(31, 680+def.bump, 520);
    });
  })();

  const el = (id) => document.getElementById(id);
  function yen(n){ return "¥ " + Math.round(n).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","); }
  function pct(n){ return (Math.round(n*10)/10).toString().replace(/\.0$/,"") + "%"; }

  function initMonths(){
    const row = el("monthRow"); row.innerHTML = "";
    APP.months.forEach(m=>{
      const b = document.createElement("button");
      b.className = "chip" + (m===APP.state.month ? " active":"");
      b.textContent = m;
      b.addEventListener("click", ()=>{ APP.state.month=m; syncAll(true); });
      row.appendChild(b);
    });
  }

  function syncKPIs(){
    const d = APP.dataByMonth[APP.state.month];
    el("kpiMoney").textContent = yen(d.money);
    el("kpiMoM").textContent = d.mom + "%";
    el("kpiRepeatCnt").textContent = d.repeatCnt;
    el("kpiRepeatUsers").textContent = d.repeatUsers;
    el("kpiKanteiCnt").textContent = d.kanteiCnt;
    el("kpiKanteiUsers").textContent = d.kanteiUsers;
  }
  function syncMonthChips(){
    [...document.querySelectorAll("#monthRow .chip")].forEach(ch=>{
      ch.classList.toggle("active", ch.textContent===APP.state.month);
    });
  }

  function syncMainTab(){
    const isKpi = APP.state.mainTab==="kpi";
    el("viewKpi").classList.toggle("hidden", !isKpi);
    el("viewDetail").classList.toggle("hidden", isKpi);
    el("tabKpi").classList.toggle("active", isKpi);
    el("tabKpi").setAttribute("aria-selected", isKpi ? "true":"false");
    el("tabDetail").classList.toggle("active", !isKpi);
    el("tabDetail").setAttribute("aria-selected", !isKpi ? "true":"false");
  }

  function syncDetailTab(){
    const isUser = APP.state.detailTab==="user";
    el("panelUser").classList.toggle("hidden", !isUser);
    el("panelReader").classList.toggle("hidden", isUser);
    [...document.querySelectorAll(".tab")].forEach(t=>{
      t.classList.toggle("active", t.dataset.detail===APP.state.detailTab);
    });
  }

  function syncUserPanel(){
    const d = APP.dataByMonth[APP.state.month].user;
    const ageWrap = el("ageList"); ageWrap.innerHTML = "";
    d.age.forEach(item=>{
      const block = document.createElement("div");
      block.className = "barItem";
      block.innerHTML = `
        <div class="barTop"><div>${item.label}</div><div class="pct">${pct(item.pct)}</div></div>
        <div class="barBg"><div class="barFill" style="width:${Math.max(0,Math.min(100,item.pct))}%"></div></div>
      `;
      ageWrap.appendChild(block);
    });

    const f = d.gender.female, m = d.gender.male;
    el("femaleBar").style.width = f + "%";
    el("maleBar").style.width = m + "%";
    el("femalePct").textContent = f + "%";
    el("malePct").textContent = m + "%";
  }

  function syncReaderPanel(){
    const d = APP.dataByMonth[APP.state.month].reader;
    el("waitThis").textContent = d.waitThis + "h";
    el("waitPrev").textContent = d.waitPrev + "h";
    el("waitMoM").textContent = d.waitMoM + "%";
    el("amTotal").textContent = d.after.total;
    el("amSent").textContent = d.after.sent;
    el("amUnsent").textContent = d.after.unsent;
    el("amRate").textContent = d.after.rate + "%";
  }

  function syncP2(){
    const d = APP.dataByMonth[APP.state.month].p2;
    const rows = el("p2Rows"); rows.innerHTML = "";
    d.counts.forEach(item=>{
      const r = document.createElement("div");
      r.className = "p2Row";
      r.innerHTML = `
        <div>${item.label}</div>
        <div class="p2BarBg"><div class="p2BarFill" style="width:${Math.max(0,Math.min(100,item.pct))}%"></div></div>
        <div style="text-align:right;">${item.n}人</div>
        <div style="text-align:right;">${pct(item.pct)}</div>
      `;
      rows.appendChild(r);
    });
  }

  function slotForMode(mode){
    if(mode==="weekday") return 110;  // 曜日別は「右にスライド」前提で広め
    if(mode==="hour") return 74;      // 時間別も横に流す
    return 56;                       // 日別は多いので少し詰める
  }

  const chart = {
    canvas:null, ctx:null, inner:null, viewport:null, xLabelViewport:null, xLabelRow:null,
    w:0, h:0, padding:{ left:10, right:46, top:10, bottom:10 }, yMax:1155, slot:64,
    setSize(){
      this.slot = slotForMode(APP.state.chartMode);
      const vpRect = this.viewport.getBoundingClientRect();
      const dpr = Math.max(1, window.devicePixelRatio || 1);
      const d = APP.dataByMonth[APP.state.month].chart[APP.state.chartMode];
      const n = d.values.length;

      const innerW = Math.max(vpRect.width, (n-1)*this.slot + this.padding.left + this.padding.right);
      const innerH = vpRect.height;

      this.inner.style.width = innerW + "px";
      this.inner.style.height = innerH + "px";

      this.w = Math.floor(innerW);
      this.h = Math.floor(innerH);

      this.canvas.width = Math.floor(this.w * dpr);
      this.canvas.height = Math.floor(this.h * dpr);
      this.canvas.style.width = this.w + "px";
      this.canvas.style.height = this.h + "px";
      this.ctx.setTransform(dpr,0,0,dpr,0,0);

      this.xLabelRow.style.width = innerW + "px";
      this.xLabelRow.style.setProperty("--slot", this.slot + "px");
    },
    draw(){
      const ctx = this.ctx;
      const {w,h,padding} = this;
      ctx.clearRect(0,0,w,h);
      ctx.fillStyle = "#ffffff";
      ctx.fillRect(0,0,w,h);

      const gridYs = [ padding.top + 8, (h + padding.top - padding.bottom)/2, h - padding.bottom - 8 ];
      ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue("--grid").trim() || "#e5e7eb";
      ctx.lineWidth = 1;
      ctx.setLineDash([3,4]);
      gridYs.forEach(y=>{
        ctx.beginPath(); ctx.moveTo(padding.left, y); ctx.lineTo(w - padding.right, y); ctx.stroke();
      });
      ctx.setLineDash([]);

      const d = APP.dataByMonth[APP.state.month].chart[APP.state.chartMode];
      const values = d.values;
      const n = values.length;
      if(n===0) return;

      const maxV = Math.max(...values, 1);
      const targetMax = Math.max(1155, Math.ceil(maxV/5)*5);
      this.yMax = targetMax;

      el("yTop").textContent = targetMax.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
      el("yMid").textContent = Math.round(targetMax*2/3).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
      el("yBot").textContent = Math.round(targetMax*1/3).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");

      const x0 = padding.left;
      const y0 = h - padding.bottom;
      const y1 = padding.top;
      const dx = this.slot;

      const pts = values.map((v,i)=>{
        const x = x0 + dx*i;
        const t = v / targetMax;
        const y = y0 - (y0 - y1) * t;
        return {x,y,v,i};
      });

      ctx.beginPath();
      ctx.moveTo(pts[0].x, y0);
      pts.forEach(p=>ctx.lineTo(p.x,p.y));
      ctx.lineTo(pts[pts.length-1].x, y0);
      ctx.closePath();
      ctx.fillStyle = "rgba(37,99,235,.10)";
      ctx.fill();

      ctx.beginPath();
      pts.forEach((p,idx)=>{ if(idx===0) ctx.moveTo(p.x,p.y); else ctx.lineTo(p.x,p.y); });
      ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue("--blue").trim() || "#2563eb";
      ctx.lineWidth = 2;
      ctx.stroke();

      const idx = (APP.state.cursorIndex==null ? Math.floor(n/2) : APP.state.cursorIndex);
      const p = pts[Math.max(0,Math.min(n-1,idx))];
      ctx.beginPath();
      ctx.arc(p.x, p.y, 4, 0, Math.PI*2);
      ctx.fillStyle = "#ffffff";
      ctx.fill();
      ctx.lineWidth = 2;
      ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue("--blue").trim() || "#2563eb";
      ctx.stroke();

      renderXLabels(d.labels);
      renderTooltip(p.x, p.y, d.labels[p.i], p.v);
      autoScrollToX(p.x);
    }
  };

  function renderXLabels(labels){
    const row = chart.xLabelRow; row.innerHTML = "";
    labels.forEach(lab=>{ const sp = document.createElement("span"); sp.textContent = lab; row.appendChild(sp); });
  }

  function autoScrollToX(x){
    const vp = chart.viewport;
    const left = vp.scrollLeft, right = left + vp.clientWidth, pad = 40;
    if(x < left + pad) vp.scrollLeft = Math.max(0, x - pad);
    else if(x > right - pad) vp.scrollLeft = Math.max(0, x - vp.clientWidth + pad);
  }

  function renderTooltip(x, y, label, val){
    const vp = chart.viewport;
    const line = el("cursorLine");
    const tip = el("tooltip");
    line.style.display = "block";
    tip.style.display = "block";
    line.style.left = x + "px";

    el("tipLabel").textContent = label;
    el("tipValue").textContent = yen(val);

    const visibleLeft = vp.scrollLeft;
    const visibleRight = visibleLeft + vp.clientWidth;

    let tipX = x;
    tip.style.left = tipX + "px";
    tip.style.top = (y + 6) + "px";

    const tipW = tip.offsetWidth;
    const min = visibleLeft + 10 + tipW/2;
    const max = visibleRight - 10 - tipW/2;
    if(tipX < min) tipX = min;
    if(tipX > max) tipX = max;
    tip.style.left = tipX + "px";
  }

  function pickIndexFromClientX(clientX){
    const d = APP.dataByMonth[APP.state.month].chart[APP.state.chartMode];
    const n = d.values.length;
    const rect = chart.viewport.getBoundingClientRect();
    const xInViewport = clientX - rect.left;
    const xInInner = xInViewport + chart.viewport.scrollLeft;
    const x0 = chart.padding.left;
    const dx = chart.slot;
    const i = Math.round((xInInner - x0) / dx);
    return Math.max(0, Math.min(n-1, i));
  }

  function attachScrollSync(){
    const vp = chart.viewport;
    const xvp = chart.xLabelViewport;
    let lock = false;

    vp.addEventListener("scroll", ()=>{
      if(lock) return;
      lock = true;
      xvp.scrollLeft = vp.scrollLeft;
      lock = false;
    }, {passive:true});

    xvp.addEventListener("scroll", ()=>{
      if(lock) return;
      lock = true;
      vp.scrollLeft = xvp.scrollLeft;
      lock = false;
    }, {passive:true});
  }

  // PCのマウスは「ドラッグで横スクロール」＋「クリックで点を選ぶ」
  function attachViewportPanAndSelect(){
    const vp = chart.viewport;
    let down = false;
    let moved = false;
    let startX = 0;
    let startScroll = 0;

    vp.addEventListener("pointerdown", (e)=>{
      // タッチはネイティブスクロール優先（ここでは何もしない）
      if(e.pointerType !== "mouse") return;
      if(e.button !== 0) return;

      down = true;
      moved = false;
      startX = e.clientX;
      startScroll = vp.scrollLeft;
      vp.setPointerCapture(e.pointerId);
    });

    vp.addEventListener("pointermove", (e)=>{
      if(!down) return;
      const dx = e.clientX - startX;
      if(Math.abs(dx) > 3) moved = true;
      vp.scrollLeft = startScroll - dx;
    });

    vp.addEventListener("pointerup", (e)=>{
      if(!down) return;
      down = false;
      try{ vp.releasePointerCapture(e.pointerId); }catch(_){}
      // 動いてないなら「クリック」とみなして点を選ぶ
      if(!moved){
        APP.state.cursorIndex = pickIndexFromClientX(e.clientX);
        chart.draw();
      }
    });

    vp.addEventListener("pointercancel", (e)=>{ down = false; });

    // タッチでタップしたときに点を選べるように（スクロール後の誤爆はほぼ起きない）
    vp.addEventListener("click", (e)=>{
      if(e.detail === 0) return; // programmatic
      // マウスのクリックはpointerup側で処理済みなので二重にしない
      // ただし一部環境でpointerupが来ない場合の保険
      if(e.pointerType === "mouse") return;
      APP.state.cursorIndex = pickIndexFromClientX(e.clientX);
      chart.draw();
    }, {passive:true});
  }

  function syncChartModeButtons(){
    [...document.querySelectorAll(".toggle")].forEach(b=>{
      b.classList.toggle("active", b.dataset.mode===APP.state.chartMode);
    });
  }

  function syncAll(resetScroll){
    syncMonthChips();
    syncKPIs();
    syncUserPanel();
    syncReaderPanel();
    syncP2();
    syncMainTab();
    syncDetailTab();
    syncChartModeButtons();

    if(APP.state.mainTab==="kpi"){
      chart.setSize();
      if(resetScroll){
        chart.viewport.scrollLeft = 0;
        chart.xLabelViewport.scrollLeft = 0;
      }
      chart.draw();
    }
  }

  function attachUIEvents(){
    el("tabKpi").addEventListener("click", ()=>{ APP.state.mainTab="kpi"; syncAll(false); });
    el("tabDetail").addEventListener("click", ()=>{ APP.state.mainTab="detail"; syncAll(false); });

    [...document.querySelectorAll(".toggle")].forEach(b=>{
      b.addEventListener("click", ()=>{
        APP.state.chartMode = b.dataset.mode;
        APP.state.cursorIndex = null;
        syncAll(true);
      });
    });

    [...document.querySelectorAll(".tab")].forEach(b=>{
      b.addEventListener("click", ()=>{
        APP.state.detailTab = b.dataset.detail;
        syncAll(false);
      });
    });

    window.addEventListener("resize", ()=>{
      if(APP.state.mainTab==="kpi"){
        chart.setSize();
        chart.draw();
      }
    });
  }

  (function boot(){
    initMonths();

    chart.canvas = el("chart");
    chart.ctx = chart.canvas.getContext("2d");
    chart.inner = el("chartInner");
    chart.viewport = el("chartViewport");
    chart.xLabelViewport = el("xLabelsViewport");
    chart.xLabelRow = el("xLabels");

    attachUIEvents();
    attachScrollSync();
    attachViewportPanAndSelect();

    syncAll(true);
  })();
</script>
</body>
</html>
