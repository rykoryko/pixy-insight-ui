<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ピクシーインサイト（サンプル）</title>
  <style>
    :root{
      --bg:#f5f7ff;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --line:#e6e8f2;
      --pill:#0b1220;
      --pillOff:#eef1ff;
      --accent:#1e3a8a;
      --blue:#2563eb;
      --shadow:0 14px 40px rgba(15,23,42,.10);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", "Yu Gothic", sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    .wrap{
      max-width:1100px;
      margin:0 auto;
      padding:18px 16px 28px;
    }
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:16px;
    }
    .pageTitle{
      font-size:24px;
      font-weight:900;
      letter-spacing:.02em;
      white-space:nowrap;
    }
    .monthPills{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .pill{
      border:0;
      border-radius:999px;
      padding:10px 14px;
      font-weight:800;
      cursor:pointer;
      background:var(--pillOff);
      color:#111827;
      box-shadow:none;
    }
    .pill.active{
      background:var(--pill);
      color:#fff;
    }

    .summaryGrid{
      display:grid;
      grid-template-columns: 1.25fr .75fr;
      gap:14px;
      align-items:stretch;
      margin-bottom:14px;
    }
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
    }
    .card.pad{ padding:16px 16px; }
    .kpiTitle{ color:var(--muted); font-weight:800; font-size:13px; }
    .kpiValue{
      margin-top:8px;
      font-size:30px;
      font-weight:950;
      letter-spacing:.01em;
    }

    .detailCard{
      padding:16px 16px;
      display:flex;
      flex-direction:column;
      justify-content:center;
      cursor:pointer;
    }
    .detailCard .label{
      color:var(--muted);
      font-weight:800;
      font-size:13px;
      margin-bottom:8px;
    }
    .detailCard .num{
      font-size:42px;
      font-weight:950;
      line-height:1.05;
    }

    .chartCard{
      padding:14px 14px 12px;
    }
    .chartHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:8px;
    }
    .seg{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .segBtn{
      border:0;
      border-radius:999px;
      padding:10px 14px;
      font-weight:900;
      cursor:pointer;
      background:#eef1ff;
      color:#111827;
    }
    .segBtn.active{
      background:var(--pill);
      color:#fff;
    }

    .chartArea{
      position:relative;
      height:240px;
      border-radius:16px;
      background: linear-gradient(180deg, #f7f8ff 0%, #ffffff 70%);
      border:1px solid #eef0ff;
      overflow:hidden;
    }
    canvas{ display:block; width:100%; height:100%; }

    .xAxisLabels{
      position:relative;
      height:22px;
      margin-top:6px;
      color:#9aa3b2;
      font-weight:800;
      font-size:12px;
    }
    .xAxisLabels span{
      position:absolute;
      bottom:0;
      transform:translateX(-50%);
      white-space:nowrap;
    }
    .xAxisLabels span.first{ transform:translateX(0); }
    .xAxisLabels span.last{ transform:translateX(-100%); }

    .yAxisLabels{
      position:absolute;
      top:10px;
      right:10px;
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:10px;
      font-weight:900;
      font-size:13px;
      color:#9aa3b2;
      user-select:none;
      pointer-events:none;
    }

    .tooltip{
      position:absolute;
      min-width:90px;
      background:#fff;
      border:1px solid #e6e8f2;
      border-radius:18px;
      padding:clamp(8px,2.4vw,12px) clamp(10px,3.0vw,14px);
      box-shadow:0 18px 44px rgba(15,23,42,.12);
      transform:translate(-50%,-120%);
      opacity:0;
      pointer-events:none;
      transition:opacity .12s ease, transform .12s ease;
    }
    .tooltip.show{
      opacity:1;
      transform:translate(-50%,-130%);
    }
    .ttLabel{font-weight:900;font-size:clamp(12px,3.0vw,14px);line-height:1.1}
    .ttVal{margin-top:4px;font-weight:900;font-size:clamp(15px,3.8vw,18px);line-height:1.1;color:#6b7280}

    .panelWrap{
      margin-top:14px;
    }
    .tabs{
      display:flex;
      gap:12px;
      margin-bottom:12px;
    }
    .tabBtn{
      border:0;
      border-radius:999px;
      padding:10px 14px;
      font-weight:950;
      cursor:pointer;
      background:var(--pillOff);
      color:#111827;
      min-width:120px;
    }
    .tabBtn.active{
      background:var(--pill);
      color:#fff;
    }
    .panel{
      padding:14px 14px 14px;
    }
    .panelTitle{
      font-size:22px;
      font-weight:950;
      margin:2px 0 12px;
    }
    .subKpiGrid{
      display:grid;
      grid-template-columns:repeat(2,1fr);
      gap:12px;
    }
.subKpiGrid3{grid-template-columns:repeat(3,1fr);}
.subKpiGrid4{grid-template-columns:repeat(4,1fr);}
.subKpi.compact{padding:10px 10px;}
.subKpi.compact .label{font-size:11px;}
.subKpi.compact .value{font-size:18px;}
.kSection{margin-top:14px;}
.kSectionTitle{font-size:13px;font-weight:900;color:#111827;margin-top:4px;}
@media (max-width: 420px){
  .subKpiGrid3{grid-template-columns:repeat(2,1fr);}
  .subKpiGrid4{grid-template-columns:repeat(2,1fr);}
  .subKpi.compact .value{font-size:17px;}
}

    .subKpi{
      border-radius:16px;
      background:#f7f8ff;
      border:1px solid #eef0ff;
      padding:12px 12px;
      box-shadow:0 10px 26px rgba(15,23,42,.06);
    }
    .subKpi .label{
      font-size:12px;
      font-weight:900;
      color:#6b7280;
    }
    .subKpi .value{
      margin-top:8px;
      font-size:26px;
      font-weight:950;
    }
    .subNote{
      margin-top:10px;
      font-size:13px;
      color:#6b7280;
      font-weight:800;
    }

    .ageList{
      margin-top:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .ageRow{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      align-items:center;
    }
    .ageLabel{
      font-weight:900;
      color:#111827;
    }
    .ageVal{
      font-weight:950;
      color:#111827;
    }
    .bar{
      grid-column: 1 / -1;
      height:10px;
      background:#eef0ff;
      border-radius:999px;
      overflow:hidden;
      border:1px solid #e9ecff;
    }
    .bar > i{
      display:block;
      height:100%;
      width:0%;
      background:linear-gradient(90deg, #2f6bff 0%, #1e3a8a 100%);
      border-radius:999px;
    }

    .hidden{ display:none !important; }

    /* view detail */
    .backRow{
      display:flex;
      align-items:center;
      gap:12px;
      margin:8px 0 12px;
    }
    .backBtn{
      border:0;
      border-radius:999px;
      padding:10px 14px;
      font-weight:950;
      cursor:pointer;
      background:#111827;
      color:#fff;
    }
    .detailTitle{
      font-weight:950;
      font-size:18px;
    }
    .tableWrap{
      margin-top:12px;
      overflow:auto;
      border-radius:16px;
      border:1px solid var(--line);
      background:#fff;
      box-shadow:var(--shadow);
    }
    table{
      width:100%;
      border-collapse:collapse;
      min-width:520px;
    }
    th,td{
      padding:12px 12px;
      border-bottom:1px solid #eef0ff;
      text-align:left;
      font-weight:900;
      font-size:13px;
      color:#111827;
      white-space:nowrap;
    }
    th{
      background:#f7f8ff;
      color:#6b7280;
      font-weight:950;
    }
    tr:last-child td{ border-bottom:0; }

    @media (max-width: 860px){
      .summaryGrid{ grid-template-columns:1fr; }
      .monthPills{ justify-content:flex-start; }
      .kpiValue{ font-size:28px; }
      .detailCard .num{ font-size:38px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="pageTitle">ピクシーインサイト</div>
      <div class="monthPills" id="monthPills"></div>
    </div>

    <div id="viewMain">
      <div class="summaryGrid">
        <div class="card pad" id="cardRevenue">
          <div class="kpiTitle">報酬金（有料）</div>
          <div class="kpiValue" id="revVal">¥0</div>
        </div>
        <button class="card detailCard" id="tabDetail" type="button">
          <div class="label">鑑定データ詳細</div>
          <div class="num" id="detailNum">0</div>
        </button>
      </div>

      <div class="card chartCard">
        <div class="chartHeader">
          <div class="kpiTitle" style="font-size:14px;font-weight:950;color:#111827">報酬金グラフ</div>
          <div class="seg">
            <button class="segBtn active" id="modeDay" type="button">日別</button>
            <button class="segBtn" id="modeHour" type="button">時間別</button>
            <button class="segBtn" id="modeWeek" type="button">曜日別</button>
          </div>
        </div>

        <div class="chartArea" id="chartArea">
          <canvas id="chartCanvas"></canvas>
          <div class="yAxisLabels" id="yAxisLabels"></div>
          <div class="tooltip" id="tooltip">
            <div class="ttLabel" id="ttLabel">1日</div>
            <div class="ttVal" id="ttVal">¥0</div>
          </div>
        </div>
        <div class="xAxisLabels" id="xAxisLabels"></div>
      </div>

      <div class="panelWrap card">
        <div class="panel" style="padding-top:16px;">
          <div class="tabs">
            <button class="tabBtn active" id="btnDetailUser" type="button">ユーザー分析</button>
            <button class="tabBtn" id="btnDetailKanteishi" type="button">鑑定師分析</button>
          </div>

          <div id="panelUser">
            <div class="panelTitle">ユーザー分析</div>

            <div class="subKpiGrid">
              <div class="subKpi">
                <div class="label">男女比率</div>
                <div class="value" id="genderRatio">男: 50% / 女: 50%</div>
              </div>
              <div class="subKpi">
                <div class="label">年齢構成比（上位）</div>
                <div class="value" id="ageTop">30-39: 0%</div>
              </div>
            </div>

            <div class="ageList" id="ageList"></div>
            <div class="subNote">※ここは「ユーザーごとの数字」を出す場所。いまは動作確認用のサンプル表示です。</div>
          </div>

<div id="panelKanteishi" class="hidden">
          <div class="panel">
            <div class="panelTitle">鑑定師分析</div>

            <div class="kSection">
              <div class="kSectionTitle">■待機時間</div>
              <div class="subKpiGrid subKpiGrid3">
                <div class="subKpi compact">
                  <div class="label">今月の待機時間</div>
                  <div class="value" id="kWaitThis">100h</div>
                </div>
                <div class="subKpi compact">
                  <div class="label">前月の待機時間</div>
                  <div class="value" id="kWaitPrev">110h</div>
                </div>
                <div class="subKpi compact">
                  <div class="label">前月比</div>
                  <div class="value" id="kWaitRatio">90%</div>
                </div>
              </div>
            </div>

            <div class="kSection">
              <div class="kSectionTitle">■アフターメッセージ</div>
              <div class="subKpiGrid subKpiGrid4">
                <div class="subKpi compact">
                  <div class="label">鑑定件数</div>
                  <div class="value" id="kAfterCalls">10</div>
                </div>
                <div class="subKpi compact">
                  <div class="label">送信数</div>
                  <div class="value" id="kAfterSent">6</div>
                </div>
                <div class="subKpi compact">
                  <div class="label">未送信</div>
                  <div class="value" id="kAfterUnsent">4</div>
                </div>
                <div class="subKpi compact">
                  <div class="label">送信率</div>
                  <div class="value" id="kAfterRate">60%</div>
                </div>
              </div>
            </div>

            <div class="subNote">※ここは「鑑定師ごとの数字」を出す場所。いまは動作確認用のサンプル表示です。</div>
          </div>
        </div>
        </div>
      </div>
    </div>

    <div id="viewDetail" class="hidden">
      <div class="backRow">
        <button class="backBtn" id="btnBack" type="button">戻る</button>
        <div class="detailTitle">鑑定データ詳細</div>
      </div>

      <div class="card pad">
        <div class="kpiTitle">回数別ユーザー数（サンプル）</div>
        <div class="tableWrap">
          <table>
            <thead>
              <tr>
                <th>回数</th>
                <th>ユーザー数</th>
                <th>構成比</th>
              </tr>
            </thead>
            <tbody id="countTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
      // ===== サンプルデータ（動作確認用） =====
      var sample = {
        months: {
          "12": {
            monthLabel: "12月",
            revenue: 100000,
            detailCount: 76,
            chart: {
              day: {
                labels: Array.from({length:31}, (_,i)=> (i+1) + "日"),
                values: [2500,2100,1800,1600,1400,1200,900,1100,1300,1500,1700,1600,1400,1200,1100,1000,900,950,1000,1050,1100,1200,1300,1250,1150,1050,950,900,700,500,300]
              },
              hour: {
                labels: Array.from({length:24}, (_,i)=> (i) + "時"),
                values: [100,80,60,50,50,70,120,220,360,420,390,330,280,260,240,230,250,280,310,340,370,420,500,560]
              },
              week: {
                labels: ["日","月","火","水","木","金","土"],
                values: [1200, 900, 980, 1100, 1000, 1300, 1500]
              }
            },
            user: {
              gender: { male: 0.43, female: 0.57 },
              age: [
                {range:"-29", ratio:0.18},
                {range:"30-39", ratio:0.34},
                {range:"40-49", ratio:0.26},
                {range:"50-59", ratio:0.14},
                {range:"60-69", ratio:0.06},
                {range:"70-", ratio:0.02},
              ]
            },
            detailTable: [
              {n:"1回", users: 350, ratio: 0.62},
              {n:"2回", users: 130, ratio: 0.23},
              {n:"3回", users: 55, ratio: 0.10},
              {n:"4回", users: 18, ratio: 0.03},
              {n:"5回以上", users: 12, ratio: 0.02},
            ]
          },
          "11": {
            monthLabel: "11月",
            revenue: 95000,
            detailCount: 71,
            chart: {
              day: { labels: Array.from({length:30}, (_,i)=> (i+1) + "日"), values: Array.from({length:30}, (_,i)=> Math.max(200, 2200 - i*55)) },
              hour: { labels: Array.from({length:24}, (_,i)=> (i) + "時"), values: [90,70,55,50,50,65,110,210,340,400,370,320,270,250,230,220,235,260,290,320,350,400,470,520] },
              week: { labels: ["日","月","火","水","木","金","土"], values: [1100, 880, 940, 1050, 980, 1250, 1450] }
            },
            user: {
              gender: { male: 0.45, female: 0.55 },
              age: [
                {range:"-29", ratio:0.17},
                {range:"30-39", ratio:0.33},
                {range:"40-49", ratio:0.27},
                {range:"50-59", ratio:0.15},
                {range:"60-69", ratio:0.06},
                {range:"70-", ratio:0.02},
              ]
            },
            detailTable: [
              {n:"1回", users: 330, ratio: 0.61},
              {n:"2回", users: 128, ratio: 0.24},
              {n:"3回", users: 54, ratio: 0.10},
              {n:"4回", users: 18, ratio: 0.03},
              {n:"5回以上", users: 11, ratio: 0.02},
            ]
          },
          "10": {
            monthLabel: "10月",
            revenue: 112000,
            detailCount: 82,
            chart: {
              day: { labels: Array.from({length:31}, (_,i)=> (i+1) + "日"), values: Array.from({length:31}, (_,i)=> Math.max(300, 2400 - i*60)) },
              hour: { labels: Array.from({length:24}, (_,i)=> (i) + "時"), values: [110,90,70,60,55,75,130,240,380,440,410,350,300,280,260,245,260,290,330,360,390,440,520,590] },
              week: { labels: ["日","月","火","水","木","金","土"], values: [1250, 950, 1020, 1150, 1080, 1350, 1600] }
            },
            user: {
              gender: { male: 0.44, female: 0.56 },
              age: [
                {range:"-29", ratio:0.19},
                {range:"30-39", ratio:0.32},
                {range:"40-49", ratio:0.26},
                {range:"50-59", ratio:0.14},
                {range:"60-69", ratio:0.06},
                {range:"70-", ratio:0.03},
              ]
            },
            detailTable: [
              {n:"1回", users: 360, ratio: 0.63},
              {n:"2回", users: 130, ratio: 0.23},
              {n:"3回", users: 55, ratio: 0.10},
              {n:"4回", users: 19, ratio: 0.03},
              {n:"5回以上", users: 11, ratio: 0.02},
            ]
          },
          "9": {
            monthLabel: "9月",
            revenue: 130000,
            detailCount: 91,
            chart: {
              day: { labels: Array.from({length:30}, (_,i)=> (i+1) + "日"), values: Array.from({length:30}, (_,i)=> Math.max(350, 2700 - i*70)) },
              hour: { labels: Array.from({length:24}, (_,i)=> (i) + "時"), values: [140,110,90,70,60,85,150,270,410,470,440,380,330,310,290,270,285,320,360,390,420,470,560,650] },
              week: { labels: ["日","月","火","水","木","金","土"], values: [1500, 1100, 1180, 1300, 1200, 1550, 1700] }
            },
            user: {
              gender: { male: 0.46, female: 0.54 },
              age: [
                {range:"-29", ratio:0.16},
                {range:"30-39", ratio:0.35},
                {range:"40-49", ratio:0.25},
                {range:"50-59", ratio:0.14},
                {range:"60-69", ratio:0.07},
                {range:"70-", ratio:0.03},
              ]
            },
            detailTable: [
              {n:"1回", users: 390, ratio: 0.64},
              {n:"2回", users: 136, ratio: 0.22},
              {n:"3回", users: 60, ratio: 0.10},
              {n:"4回", users: 22, ratio: 0.03},
              {n:"5回以上", users: 14, ratio: 0.02},
            ]
          }
        }
      };

      var kanteishiByMonth = {
        "12": { waitThis:100, waitPrev:110, waitRatio:0.90, afterCalls:10, afterSent:6, afterUnsent:4, afterRate:0.60 },
        "11": { waitThis:100, waitPrev:110, waitRatio:0.90, afterCalls:10, afterSent:6, afterUnsent:4, afterRate:0.60 },
        "10": { waitThis:100, waitPrev:110, waitRatio:0.90, afterCalls:10, afterSent:6, afterUnsent:4, afterRate:0.60 },
        "9":  { waitThis:100, waitPrev:110, waitRatio:0.90, afterCalls:10, afterSent:6, afterUnsent:4, afterRate:0.60 }
      };
      var state = {
        monthKey: "12",
        mode: "day", // day | hour | week
        mainView: "main", // main | detail
        detailTab: "user" // user | kanteishi
      };

      // ===== DOM =====
      var monthPills = document.getElementById("monthPills");
      var revVal = document.getElementById("revVal");
      var tabDetail = document.getElementById("tabDetail");
      var detailNum = document.getElementById("detailNum");

      var viewMain = document.getElementById("viewMain");
      var viewDetail = document.getElementById("viewDetail");
      var btnBack = document.getElementById("btnBack");

      var modeDay = document.getElementById("modeDay");
      var modeHour = document.getElementById("modeHour");
      var modeWeek = document.getElementById("modeWeek");

      var chartArea = document.getElementById("chartArea");
      var canvas = document.getElementById("chartCanvas");
      var ctx = canvas.getContext("2d");
      var yAxisLabels = document.getElementById("yAxisLabels");
      var xAxisLabels = document.getElementById("xAxisLabels");

      var tooltip = document.getElementById("tooltip");
      var ttLabel = document.getElementById("ttLabel");
      var ttVal = document.getElementById("ttVal");

      var btnDetailUser = document.getElementById("btnDetailUser");
      var btnDetailKanteishi = document.getElementById("btnDetailKanteishi");
      var panelUser = document.getElementById("panelUser");
      var panelKanteishi = document.getElementById("panelKanteishi");

      var genderRatio = document.getElementById("genderRatio");
      var ageTop = document.getElementById("ageTop");
      var ageList = document.getElementById("ageList");

      var countTableBody = document.getElementById("countTableBody");

      // ===== UI: month pills =====
      function renderMonthPills(){
        monthPills.innerHTML = "";
        var keys = Object.keys(sample.months).sort((a,b)=> Number(b)-Number(a));
        keys.forEach(function(k){
          var btn = document.createElement("button");
          btn.className = "pill" + (k===state.monthKey ? " active":"");
          btn.type = "button";
          btn.textContent = sample.months[k].monthLabel;
          btn.addEventListener("click", function(){
            state.monthKey = k;
            renderAll();
          });
          monthPills.appendChild(btn);
        });
      }

      function setMainView(view){
        state.mainView = view;
        if(view==="main"){
          viewMain.classList.remove("hidden");
          viewDetail.classList.add("hidden");
          // mainに戻るときは、上にスクロールを寄せる（スマホで分かりやすい）
          window.scrollTo({top:0, behavior:"instant"});
        }else{
          viewMain.classList.add("hidden");
          viewDetail.classList.remove("hidden");
          window.scrollTo({top:0, behavior:"instant"});
        }
      }

      // ===== detail tab =====
      function setDetailTab(tab){
        state.detailTab = tab;
        if(tab==="user"){
          btnDetailUser.classList.add("active");
          btnDetailKanteishi.classList.remove("active");
          panelUser.classList.remove("hidden");
          panelKanteishi.classList.add("hidden");
        }else{
          btnDetailUser.classList.remove("active");
          btnDetailKanteishi.classList.add("active");
          panelUser.classList.add("hidden");
          panelKanteishi.classList.remove("hidden");
        }
      }

      // ===== mode buttons =====
      function setMode(mode){
        state.mode = mode;
        modeDay.classList.toggle("active", mode==="day");
        modeHour.classList.toggle("active", mode==="hour");
        modeWeek.classList.toggle("active", mode==="week");
        drawChart();
      }

      // ===== format =====
      function yen(n){
        return "¥ " + Number(n).toLocaleString("ja-JP");
      }
      function pct(r){
        return Math.round(r*1000)/10 + "%";
      }

      // ===== user panels =====
      function renderUserPanels(){
        var m = sample.months[state.monthKey];
        var male = m.user.gender.male;
        var female = m.user.gender.female;
        genderRatio.textContent = "男: " + pct(male) + " / 女: " + pct(female);

        // age list
        ageList.innerHTML = "";
        var max = 0;
        m.user.age.forEach(function(a){ if(a.ratio>max) max=a.ratio; });
        var top = m.user.age.slice().sort((a,b)=>b.ratio-a.ratio)[0];
        ageTop.textContent = top.range + ": " + pct(top.ratio);

        m.user.age.forEach(function(a){
          var row = document.createElement("div");
          row.className = "ageRow";
          var lab = document.createElement("div");
          lab.className = "ageLabel";
          lab.textContent = a.range;

          var val = document.createElement("div");
          val.className = "ageVal";
          val.textContent = pct(a.ratio);

          var bar = document.createElement("div");
          bar.className = "bar";
          var fill = document.createElement("i");
          fill.style.width = Math.max(2, Math.round((a.ratio / max) * 100)) + "%";
          bar.appendChild(fill);

          row.appendChild(lab);
          row.appendChild(val);
          row.appendChild(bar);
          ageList.appendChild(row);
        });
      }

      function renderKanteishiPanels(){
        var k = (kanteishiByMonth && kanteishiByMonth[state.monthKey]) ? kanteishiByMonth[state.monthKey] : (kanteishiByMonth ? kanteishiByMonth["12"] : null);
        if(!k) return;

        function setText(id, text){
          var el = document.getElementById(id);
          if(el) el.textContent = text;
        }

        setText("kWaitThis", String(k.waitThis || 0) + "h");
        setText("kWaitPrev", String(k.waitPrev || 0) + "h");
        setText("kWaitRatio", String(Math.round((k.waitRatio || 0) * 1000) / 10) + "%");

        setText("kAfterCalls", String(k.afterCalls || 0));
        setText("kAfterSent", String(k.afterSent || 0));
        setText("kAfterUnsent", String(k.afterUnsent || 0));
        setText("kAfterRate", String(Math.round((k.afterRate || 0) * 1000) / 10) + "%");
      }

      // ===== detail table =====
      function renderCountTable(){
        var m = sample.months[state.monthKey];
        countTableBody.innerHTML = "";
        m.detailTable.forEach(function(r){
          var tr = document.createElement("tr");
          var td1 = document.createElement("td");
          td1.textContent = r.n;
          var td2 = document.createElement("td");
          td2.textContent = Number(r.users).toLocaleString("ja-JP");
          var td3 = document.createElement("td");
          td3.textContent = pct(r.ratio);
          tr.appendChild(td1); tr.appendChild(td2); tr.appendChild(td3);
          countTableBody.appendChild(tr);
        });
      }

      // ===== chart drawing =====
      var chartGeom = {w:0,h:0, dpr:1, padL:14, padR:54, padT:12, padB:34, plotW:0, plotH:0};
      var chartPoints = []; // {x,y,label,val}

      function sizeCanvas(){
        var rect = chartArea.getBoundingClientRect();
        var dpr = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
        var w = Math.max(1, Math.round(rect.width));
        var h = Math.max(1, Math.round(rect.height));
        // 右端が「31日 / 23時」で切れないように、モバイルは余白を少し減らす
        chartGeom.padL = (w<=420 ? 12 : 14);
        chartGeom.padR = (w<=420 ? 28 : 54);
        chartGeom.padB = (w<=420 ? 30 : 34);

        canvas.width = Math.round(w * dpr);
        canvas.height = Math.round(h * dpr);
        canvas.style.width = w + "px";
        canvas.style.height = h + "px";
        chartGeom.w = w;
        chartGeom.h = h;
        chartGeom.dpr = dpr;
        chartGeom.plotW = w - chartGeom.padL - chartGeom.padR;
        chartGeom.plotH = h - chartGeom.padT - chartGeom.padB;
        ctx.setTransform(dpr,0,0,dpr,0,0);
      }

      function getSeries(){
        var m = sample.months[state.monthKey];
        return m.chart[state.mode];
      }

      function makeXTicks(n, maxTicks){
        if(n<=1) return [0];
        if(n<=maxTicks) return Array.from({length:n},(_,i)=>i);
        var idxs=[];
        for(var i=0;i<maxTicks;i++){
          var t = i/(maxTicks-1);
          var idx = Math.round(t*(n-1));
          idxs.push(idx);
        }
        // 重複除去
        return Array.from(new Set(idxs));
      }

      function renderAxesLabels(series, yMin, yMax){
        // y labels: 3 labels (max / mid / min)
        yAxisLabels.innerHTML = "";
        var yLabels = [yMax, Math.round((yMax+yMin)/2), yMin];
        yLabels.forEach(function(v){
          var div = document.createElement("div");
          div.textContent = Number(v).toLocaleString("ja-JP");
          yAxisLabels.appendChild(div);
        });

        // x labels: up to 7 ticks
        xAxisLabels.innerHTML = "";
        var n = series.values.length;
        var ticks = makeXTicks(n, 7);
        ticks.forEach(function(idx, i){
          var sp = document.createElement("span");
          sp.textContent = series.labels[idx];
          if(i===0) sp.classList.add("first");
          if(i===ticks.length-1) sp.classList.add("last");
          // pos under plot
          var x = chartGeom.padL + (chartGeom.plotW * (idx/(n-1 || 1)));
          sp.style.left = x + "px";
          xAxisLabels.appendChild(sp);
        });
      }

      function drawChart(){
        var series = getSeries();
        sizeCanvas();

        var values = series.values.slice();
        var n = values.length;
        var maxV = Math.max.apply(null, values);
        var minV = Math.min.apply(null, values);
        if(maxV===minV){
          maxV += 1; minV -= 1;
        }
        var yPad = (maxV-minV) * 0.12;
        var yMax = Math.round(maxV + yPad);
        var yMin = Math.max(0, Math.round(minV - yPad));

        renderAxesLabels(series, yMin, yMax);

        // clear
        ctx.clearRect(0,0,chartGeom.w,chartGeom.h);

        // grid
        ctx.save();
        ctx.globalAlpha = 1;
        ctx.strokeStyle = "#eef0ff";
        ctx.lineWidth = 1;
        var gLines = 4;
        for(var i=0;i<=gLines;i++){
          var gy = chartGeom.padT + (chartGeom.plotH * (i/gLines));
          ctx.beginPath();
          ctx.moveTo(chartGeom.padL, gy);
          ctx.lineTo(chartGeom.padL + chartGeom.plotW, gy);
          ctx.stroke();
        }
        ctx.restore();

        // build points
        chartPoints = [];
        for(var j=0;j<n;j++){
          var x = chartGeom.padL + (chartGeom.plotW * (j/(n-1 || 1)));
          var t = (values[j]-yMin) / (yMax-yMin);
          var y = chartGeom.padT + chartGeom.plotH * (1 - t);
          chartPoints.push({
            x:x, y:y,
            label: series.labels[j],
            val: values[j]
          });
        }

        // line
        ctx.save();
        ctx.strokeStyle = "#2f6bff";
        ctx.lineWidth = 4;
        ctx.lineJoin = "round";
        ctx.lineCap = "round";
        ctx.beginPath();
        chartPoints.forEach(function(p, idx){
          if(idx===0) ctx.moveTo(p.x,p.y);
          else ctx.lineTo(p.x,p.y);
        });
        ctx.stroke();
        ctx.restore();

        // point (last)
        var last = chartPoints[chartPoints.length-1];
        ctx.save();
        ctx.fillStyle = "#2f6bff";
        ctx.beginPath();
        ctx.arc(last.x,last.y,6,0,Math.PI*2);
        ctx.fill();
        ctx.lineWidth = 4;
        ctx.strokeStyle = "#fff";
        ctx.beginPath();
        ctx.arc(last.x,last.y,6,0,Math.PI*2);
        ctx.stroke();
        ctx.restore();

        // default tooltip = last point
        showTooltipAt(last);
      }

      function showTooltipAt(p){
        if(!p) return;
        ttLabel.textContent = p.label;
        ttVal.textContent = yen(p.val);

        // place
        var left = p.x;
        var top = p.y;

        tooltip.style.left = left + "px";
        tooltip.style.top = top + "px";

        // edge handling: if too close to right, shift anchor
        var isRight = (p.x > chartGeom.padL + chartGeom.plotW*0.82);
        tooltip.style.transform = isRight ? "translate(-100%,-130%)" : "translate(-50%,-130%)";

        tooltip.classList.add("show");
      }

      function hideTooltip(){
        tooltip.classList.remove("show");
      }

      function nearestPoint(x, y){
        var best = null;
        var bestD = Infinity;
        for(var i=0;i<chartPoints.length;i++){
          var p = chartPoints[i];
          var dx = p.x - x;
          var dy = p.y - y;
          var d = dx*dx + dy*dy;
          if(d < bestD){
            bestD = d;
            best = p;
          }
        }
        return best;
      }

      function getLocalPos(e){
        var rect = chartArea.getBoundingClientRect();
        var clientX = e.touches ? e.touches[0].clientX : e.clientX;
        var clientY = e.touches ? e.touches[0].clientY : e.clientY;
        return { x: clientX - rect.left, y: clientY - rect.top };
      }

      function onPointerMove(e){
        var pos = getLocalPos(e);
        var p = nearestPoint(pos.x, pos.y);
        if(!p) return;
        showTooltipAt(p);
      }

      function onPointerLeave(){
        // 戻す：最後の点
        var last = chartPoints[chartPoints.length-1];
        showTooltipAt(last);
      }

      // ===== main render =====
      function renderAll(){
        renderMonthPills();

        var m = sample.months[state.monthKey];
        revVal.textContent = yen(m.revenue);
        detailNum.textContent = Number(m.detailCount).toLocaleString("ja-JP");

        // チャートと詳細
        renderUserPanels();
        renderKanteishiPanels();
        drawChart();

        // detail view table
        renderCountTable();

        // tab state keep
        setDetailTab(state.detailTab);
      }

      // ===== events =====
      tabDetail.addEventListener("click", function(){
        setMainView("detail");
      });
      btnBack.addEventListener("click", function(){
        setMainView("main");
      });

      modeDay.addEventListener("click", function(){ setMode("day"); });
      modeHour.addEventListener("click", function(){ setMode("hour"); });
      modeWeek.addEventListener("click", function(){ setMode("week"); });

      btnDetailUser.addEventListener("click", function(){ setDetailTab("user"); });
      btnDetailKanteishi.addEventListener("click", function(){ setDetailTab("kanteishi"); });

      chartArea.addEventListener("mousemove", onPointerMove);
      chartArea.addEventListener("mouseleave", onPointerLeave);

      chartArea.addEventListener("touchstart", function(e){ onPointerMove(e); }, {passive:true});
      chartArea.addEventListener("touchmove", function(e){ onPointerMove(e); }, {passive:true});
      chartArea.addEventListener("touchend", function(){ onPointerLeave(); }, {passive:true});

      window.addEventListener("resize", function(){
        drawChart();
      });

      // init
      renderAll();
      setDetailTab("user");
  </script>
</body>
</html>
